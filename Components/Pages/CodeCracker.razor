@page "/code-cracker"
@page "/code-cracker/{*parameters}"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.SignalR.Client
@using Arcane_Coop.Hubs
@implements IAsyncDisposable
@inject NavigationManager Navigation

<PageTitle>Code Cracker: Lexical Puzzle</PageTitle>

<div class="container">
    <div class="header-section">
        <h2 class="game-title">üîê Code Cracker: Lexical Puzzle</h2>
        <p class="game-subtitle">Caitlyn vs Vi - Decode the Corrupted Archives</p>
    </div>
    
    <div class="connection-status mb-3">
        <strong>Connection Status:</strong> 
        <span class="@(IsConnected ? "text-success" : "text-danger")">
            @(IsConnected ? "Connected" : "Disconnected")
        </span>
    </div>

    @if (!inGame)
    {
        <div class="instructions-panel">
            <div class="instruction-header">
                <h3>üéÆ How to Play Code Cracker</h3>
            </div>
            <div class="instruction-content">
                <div class="step-by-step">
                    <div class="instruction-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h4>Share Room Code</h4>
                            <p>Both players enter the <strong>same Room ID</strong> below. Choose any code like "game123" or "friends".</p>
                        </div>
                    </div>
                    <div class="instruction-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h4>Join Together</h4>
                            <p>Click <strong>"Join Room"</strong> then <strong>"Join Game"</strong>. First player becomes Caitlyn (Piltover), second becomes Vi (Zaunite).</p>
                        </div>
                    </div>
                    <div class="instruction-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h4>Collaborate to Solve</h4>
                            <p><strong>Piltover</strong> sees distorted words, <strong>Zaunite</strong> gets clues. Work together via chat to decode all 10 words!</p>
                        </div>
                    </div>
                </div>
                
                <div class="role-preview">
                    <div class="role-card piltover-preview">
                        <h4>üèõÔ∏è Caitlyn (Piltover)</h4>
                        <p>You see corrupted data like:</p>
                        <div class="preview-word">m_r_u_</div>
                        <small>Decode the missing letters</small>
                    </div>
                    <div class="role-card zaunite-preview">
                        <h4>‚ö° Vi (Zaunite)</h4>
                        <p>You get intelligence clues:</p>
                        <ul class="preview-clues">
                            <li><strong>Definition:</strong> a soft, low sound</li>
                            <li><strong>German:</strong> Fl√ºstern</li>
                            <li><strong>Synonym:</strong> whisper</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    }

    <div class="game-setup mb-4">
        <div class="row">
            <div class="col-md-6">
                <label for="roomInput" class="form-label">Room ID:</label>
                <input @bind="roomId" id="roomInput" class="form-control" placeholder="Enter room code" />
            </div>
            <div class="col-md-6">
                <label for="nameInput" class="form-label">Player Name:</label>
                <input @bind="playerName" id="nameInput" class="form-control" placeholder="Enter your name" />
            </div>
        </div>

        <div class="setup-buttons mt-3">
            <button class="btn btn-primary" @onclick="JoinRoom" disabled="@(!IsConnected || string.IsNullOrEmpty(roomId) || string.IsNullOrEmpty(playerName))">
                Join Room
            </button>
            <button class="btn btn-secondary ms-2" @onclick="LeaveRoom" disabled="@(!IsConnected || string.IsNullOrEmpty(roomId))">
                Leave Room
            </button>
            <button class="btn btn-success ms-2" @onclick="JoinGame" disabled="@(!IsConnected || string.IsNullOrEmpty(roomId) || string.IsNullOrEmpty(playerName))">
                Join Game
            </button>
        </div>
    </div>

    @if (inGame && playerView != null)
    {
        <div class="game-section">
            <div class="game-header">
                <div class="row">
                    <div class="col-md-8">
                        <h4 class="player-role @GetRoleClass()">
                            @(playerView?.DisplayName ?? "Unknown Player")
                        </h4>
                        <p class="role-instruction">@(playerView?.Instruction ?? "")</p>
                    </div>
                    <div class="col-md-4">
                        <div class="game-progress">
                            <strong>Progress:</strong> @((gameState?.CurrentWordIndex ?? 0) + 1) / @(gameState?.TotalWords ?? 0)<br/>
                            <strong>Score:</strong> @gameState?.Score<br/>
                            <strong>Hints Used:</strong> @gameState?.HintsUsed / 3
                        </div>
                    </div>
                </div>
            </div>

            <div class="puzzle-area">
                @if (playerView?.Role == "Piltover")
                {
                    <div class="piltover-section">
                        <div class="distorted-word">
                            <h3>Corrupted Archive Data:</h3>
                            <div class="word-display @(wordTransitioning ? "word-transition" : "")">@(playerView?.DistortedWord ?? "")</div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="zaunite-section">
                        <div class="zaunite-header">
                            <h3 class="intelligence-title">
                                <span class="hacker-symbol">‚ö°</span>
                                INTELLIGENCE GATHERED
                                <span class="hacker-symbol">‚ö°</span>
                            </h3>
                            <div class="hacker-lines">
                                <div class="line"></div>
                                <div class="line"></div>
                                <div class="line"></div>
                            </div>
                        </div>
                        <div class="clue-cards">
                            <div class="clue-card @clueAnimationClass">
                                <strong>Definition:</strong> @(playerView?.Definition ?? "")
                            </div>
                            <div class="clue-card @clueAnimationClass">
                                <strong>German:</strong> @(playerView?.GermanTranslation ?? "")
                            </div>
                            <div class="clue-card @clueAnimationClass">
                                <strong>Synonym:</strong> @(playerView?.Synonym ?? "")
                            </div>
                        </div>
                    </div>
                }
            </div>

            <div class="game-actions">
                <div class="guess-section">
                    <div class="input-group">
                        <input @bind="currentGuess" @onkeypress="@(async (e) => { if (e.Key == "Enter") await SubmitGuess(); })" 
                               class="form-control" placeholder="Enter your guess..." />
                        <button class="btn btn-primary" @onclick="SubmitGuess" disabled="@(!IsConnected || string.IsNullOrEmpty(currentGuess))">
                            Submit Guess
                        </button>
                    </div>
                </div>

                <div class="game-controls mt-3">
                    <button class="btn btn-info" @onclick="RequestHint" disabled="@(!IsConnected || gameState?.HintsUsed >= 3)">
                        Request Hint (@(3 - (gameState?.HintsUsed ?? 0)) left)
                    </button>
                    <button class="btn btn-warning ms-2" @onclick="RestartGame" disabled="@(!IsConnected)">
                        Restart Game
                    </button>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(gameStatus))
            {
                <div class="alert @GetStatusClass() mt-3">@gameStatus</div>
            }

            @if (!string.IsNullOrEmpty(latestHint))
            {
                <div class="alert alert-info mt-2">
                    <strong>Hint:</strong> @latestHint
                </div>
            }

            @if (playerView?.AttemptHistory?.Any() == true)
            {
                <div class="attempt-history mt-3">
                    <h5>Recent Attempts:</h5>
                    <ul class="list-group">
                        @foreach (var attempt in playerView.AttemptHistory)
                        {
                            <li class="list-group-item">@attempt</li>
                        }
                    </ul>
                </div>
            }

            @if (gameState?.PlayersNeeded > 0)
            {
                <div class="connection-guidance">
                    <div class="waiting-indicator">
                        <span>Waiting for @gameState.PlayersNeeded more player(s) to join</span>
                        <div class="loading-dots">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                        </div>
                    </div>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.8; font-size: 0.9rem;">
                        Share your Room ID "<strong>@roomId</strong>" with your partner!
                    </p>
                </div>
            }
        </div>
    }

    @if (showSuccessAnimation)
    {
        <div class="success-overlay" @onclick="() => showSuccessAnimation = false">
            <div class="success-content">
                <div class="success-title">üéâ DECODED!</div>
                <div class="success-message">@successMessage</div>
                <p style="opacity: 0.8;">Click anywhere to continue...</p>
            </div>
        </div>
    }

    <div class="chat-section mt-4">
        <h5>Team Communication</h5>
        <div class="input-group mb-3">
            <input @bind="messageInput" @onkeypress="@(async (e) => { if (e.Key == "Enter") await SendMessage(); })" 
                   class="form-control" placeholder="Coordinate with your partner..." />
            <button class="btn btn-success" @onclick="SendMessage" disabled="@(!IsConnected || string.IsNullOrEmpty(messageInput))">
                Send
            </button>
        </div>

        <div class="messages-container">
            @foreach (var message in messages)
            {
                <div class="message">@message</div>
            }
        </div>
    </div>
</div>

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Cinzel:wght@400;600&family=Rajdhani:wght@300;400;500;600;700&display=swap');

    /* Load Arcane Nine font */
    @@font-face {
        font-family: 'Arcane Nine';
        src: url('/fonts/Arcane Nine.otf') format('opentype');
        font-weight: normal;
        font-style: normal;
        font-display: swap;
    }

    :root {
        --zaun-primary: #0f3427;
        --zaun-secondary: #1e5f47;
        --zaun-accent: #00d4aa;
        --zaun-glow: #00ffc8;
        --zaun-dark: #0a1e16;
        --shimmer-pink: #ff007f;
        --piltover-primary: #2c1810;
        --piltover-secondary: #5c3317;
        --piltover-accent: #c8aa6e;
        --piltover-glow: #ffd700;
        --piltover-light: #f5e6a3;
        --hextech-blue: #0596aa;
        --arcane-blue: #0596aa;
        --neutral-dark: #000a0f;
        --neutral-light: #f0f8ff;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body, html {
        margin: 0;
        padding: 0;
        background: var(--neutral-dark);
        overflow-x: hidden;
    }

    .container {
        position: relative;
        min-height: 100vh;
        width: 100vw;
        margin: 0;
        padding: 1rem;
        font-family: 'Rajdhani', sans-serif;
        color: var(--neutral-light);
        background: linear-gradient(135deg, var(--zaun-dark) 0%, var(--neutral-dark) 50%, var(--piltover-primary) 100%);
        background-attachment: fixed;
        box-sizing: border-box;
    }

    .container::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: 
            radial-gradient(circle at 20% 80%, rgba(0, 212, 170, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(200, 170, 110, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 50% 50%, rgba(5, 150, 170, 0.05) 0%, transparent 60%);
        animation: atmosphereFlow 12s ease-in-out infinite alternate;
        pointer-events: none;
        z-index: -1;
    }

    @@keyframes atmosphereFlow {
        0% { opacity: 0.6; transform: scale(1) rotate(0deg); }
        50% { opacity: 1; transform: scale(1.02) rotate(1deg); }
        100% { opacity: 0.8; transform: scale(1.01) rotate(-1deg); }
    }

    .header-section {
        text-align: center;
        padding: 2rem 0;
        position: relative;
        z-index: 10;
    }

    .game-title {
        font-family: 'Arcane Nine', fantasy;
        font-size: 3.5rem;
        background: linear-gradient(45deg, var(--piltover-accent), var(--zaun-accent), var(--hextech-blue));
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 0 30px rgba(200, 170, 110, 0.5), 0 0 60px rgba(0, 212, 170, 0.3);
        margin-bottom: 0.5rem;
        animation: titleGlow 4s ease-in-out infinite alternate;
    }

    @@keyframes titleGlow {
        0% { filter: brightness(1) drop-shadow(0 0 20px rgba(200, 170, 110, 0.4)); }
        100% { filter: brightness(1.2) drop-shadow(0 0 40px rgba(0, 212, 170, 0.6)); }
    }

    .game-subtitle {
        font-family: 'Cinzel', serif;
        font-size: 1.2rem;
        color: var(--neutral-light);
        opacity: 0.9;
        margin-bottom: 2rem;
        text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }

    .connection-status {
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(200, 170, 110, 0.3);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 2rem;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .game-setup {
        background: rgba(0,0,0,0.4);
        border: 1px solid rgba(200, 170, 110, 0.3);
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    .form-label {
        color: var(--piltover-accent);
        font-weight: 600;
        margin-bottom: 0.5rem;
        text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }

    .form-control {
        background: rgba(0,0,0,0.5);
        border: 1px solid rgba(200, 170, 110, 0.4);
        border-radius: 8px;
        color: var(--neutral-light);
        padding: 0.75rem;
        font-family: 'Rajdhani', sans-serif;
        font-size: 1.1rem;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        background: rgba(0,0,0,0.7);
        border-color: var(--zaun-accent);
        box-shadow: 0 0 0 0.2rem rgba(0, 212, 170, 0.25), 0 0 20px rgba(0, 212, 170, 0.3);
        color: var(--neutral-light);
    }

    .btn {
        font-family: 'Rajdhani', sans-serif;
        font-weight: 600;
        font-size: 1.1rem;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: none;
        position: relative;
        overflow: hidden;
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }

    .btn:hover::before {
        left: 100%;
    }

    .btn-primary {
        background: linear-gradient(45deg, var(--hextech-blue), var(--zaun-accent));
        color: white;
        box-shadow: 0 4px 15px rgba(5, 150, 170, 0.4);
    }

    .btn-primary:hover {
        background: linear-gradient(45deg, var(--zaun-accent), var(--hextech-blue));
        box-shadow: 0 6px 20px rgba(0, 212, 170, 0.6);
        transform: translateY(-2px);
    }

    .btn-secondary {
        background: linear-gradient(45deg, var(--piltover-secondary), var(--piltover-accent));
        color: white;
        box-shadow: 0 4px 15px rgba(200, 170, 110, 0.4);
    }

    .btn-secondary:hover {
        background: linear-gradient(45deg, var(--piltover-accent), var(--piltover-secondary));
        box-shadow: 0 6px 20px rgba(200, 170, 110, 0.6);
        transform: translateY(-2px);
    }

    .btn-success {
        background: linear-gradient(45deg, var(--zaun-secondary), var(--zaun-accent));
        color: white;
        box-shadow: 0 4px 15px rgba(0, 212, 170, 0.4);
    }

    .btn-success:hover {
        background: linear-gradient(45deg, var(--zaun-accent), var(--zaun-glow));
        box-shadow: 0 6px 20px rgba(0, 255, 200, 0.6);
        transform: translateY(-2px);
    }

    .game-section {
        background: rgba(0,0,0,0.6);
        border: 2px solid;
        border-image: linear-gradient(45deg, var(--piltover-accent), var(--zaun-accent), var(--hextech-blue)) 1;
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        backdrop-filter: blur(15px);
        box-shadow: 
            0 8px 32px rgba(0,0,0,0.4),
            inset 0 1px 0 rgba(255,255,255,0.1);
        position: relative;
        overflow: hidden;
    }

    .game-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(45deg, rgba(200, 170, 110, 0.05), rgba(0, 212, 170, 0.05));
        animation: sectionGlow 8s ease-in-out infinite alternate;
        pointer-events: none;
    }

    @@keyframes sectionGlow {
        0% { opacity: 0.3; transform: scale(1); }
        100% { opacity: 0.6; transform: scale(1.01); }
    }

    .player-role {
        font-family: 'Orbitron', monospace;
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 2px;
        position: relative;
        z-index: 2;
    }

    .player-role.piltover {
        background: linear-gradient(45deg, var(--piltover-accent), var(--piltover-glow));
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 0 20px rgba(200, 170, 110, 0.5);
        filter: drop-shadow(0 2px 4px rgba(200, 170, 110, 0.3));
    }

    .player-role.zaunite {
        background: linear-gradient(45deg, var(--zaun-accent), var(--zaun-glow));
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 0 20px rgba(0, 212, 170, 0.5);
        filter: drop-shadow(0 2px 4px rgba(0, 212, 170, 0.3));
    }

    .role-instruction {
        color: var(--neutral-light);
        font-style: italic;
        margin-bottom: 1.5rem;
        opacity: 0.9;
        font-size: 1.1rem;
        position: relative;
        z-index: 2;
    }

    .game-progress {
        background: rgba(0,0,0,0.5);
        border: 1px solid rgba(200, 170, 110, 0.3);
        padding: 1.5rem;
        border-radius: 12px;
        text-align: right;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        font-family: 'Orbitron', monospace;
        position: relative;
        z-index: 2;
    }

    .puzzle-area {
        margin: 2rem 0;
        padding: 2rem;
        border-radius: 15px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    .piltover-section {
        background: linear-gradient(135deg, var(--piltover-primary) 0%, var(--piltover-secondary) 50%, var(--piltover-accent) 100%);
        color: var(--neutral-light);
        text-align: center;
        position: relative;
    }

    .piltover-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at 30% 70%, rgba(255, 215, 0, 0.1) 0%, transparent 70%);
        animation: piltoverPulse 6s ease-in-out infinite alternate;
        pointer-events: none;
    }

    @@keyframes piltoverPulse {
        0% { opacity: 0.5; transform: scale(1); }
        100% { opacity: 0.8; transform: scale(1.02); }
    }

    .zaunite-section {
        background: linear-gradient(135deg, var(--zaun-dark) 0%, var(--zaun-primary) 50%, var(--zaun-secondary) 100%);
        color: var(--neutral-light);
        position: relative;
    }

    .zaunite-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at 70% 30%, rgba(0, 255, 200, 0.1) 0%, transparent 70%);
        animation: zaunitePulse 8s ease-in-out infinite alternate;
        pointer-events: none;
    }

    @@keyframes zaunitePulse {
        0% { opacity: 0.4; transform: scale(1); }
        100% { opacity: 0.7; transform: scale(1.01); }
    }

    .word-display {
        font-family: 'Orbitron', monospace;
        font-size: 4rem;
        font-weight: 900;
        letter-spacing: 0.3em;
        margin: 2rem 0;
        padding: 2rem;
        background: rgba(0,0,0,0.4);
        border: 2px solid rgba(255,255,255,0.3);
        border-radius: 12px;
        text-transform: uppercase;
        text-shadow: 0 0 20px rgba(255,255,255,0.5);
        backdrop-filter: blur(10px);
        position: relative;
        z-index: 2;
    }

    .clue-cards {
        display: grid;
        gap: 1.5rem;
        position: relative;
        z-index: 2;
    }

    .clue-card {
        background: rgba(0,0,0,0.4);
        border-left: 4px solid var(--zaun-accent);
        padding: 1.5rem;
        border-radius: 10px;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    /* Fly-in animation classes */
    .clue-card.updating {
        animation: clueOut 0.3s ease-in forwards;
    }

    .clue-card.updated {
        animation: clueIn 0.5s ease-out forwards;
    }

    .clue-card:nth-child(1).updated { animation-delay: 0.1s; }
    .clue-card:nth-child(2).updated { animation-delay: 0.2s; }
    .clue-card:nth-child(3).updated { animation-delay: 0.3s; }

    @@keyframes clueOut {
        0% { 
            opacity: 1; 
            transform: translateX(0) scale(1);
        }
        100% { 
            opacity: 0; 
            transform: translateX(-50px) scale(0.9);
        }
    }

    @@keyframes clueIn {
        0% { 
            opacity: 0; 
            transform: translateX(50px) scale(0.9);
        }
        100% { 
            opacity: 1; 
            transform: translateX(0) scale(1);
        }
    }

    .clue-card:hover {
        transform: translateX(5px);
        box-shadow: 0 6px 20px rgba(0, 212, 170, 0.3);
    }

    .clue-card strong {
        color: var(--zaun-glow);
        text-shadow: 0 0 10px rgba(0, 255, 200, 0.5);
        font-family: 'Orbitron', monospace;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* Enhanced Zaunite Header */
    .zaunite-header {
        text-align: center;
        margin-bottom: 2rem;
        position: relative;
        z-index: 3;
    }

    .intelligence-title {
        font-family: 'Orbitron', monospace;
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--zaun-glow);
        text-transform: uppercase;
        letter-spacing: 3px;
        margin-bottom: 1rem;
        text-shadow: 0 0 15px rgba(0, 255, 200, 0.5);
        position: relative;
    }

    .hacker-symbol {
        display: inline-block;
        margin: 0 1rem;
        font-size: 2rem;
        color: var(--zaun-accent);
    }

    .hacker-lines {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .hacker-lines .line {
        width: 60px;
        height: 2px;
        background: linear-gradient(90deg, transparent, var(--zaun-accent), transparent);
        opacity: 0.6;
    }

    .game-actions {
        text-align: center;
        margin: 2rem 0;
        position: relative;
        z-index: 2;
    }

    .guess-section .input-group {
        max-width: 600px;
        margin: 0 auto 2rem;
    }

    .attempt-history {
        background: rgba(0,0,0,0.4);
        border: 1px solid rgba(200, 170, 110, 0.3);
        padding: 1.5rem;
        border-radius: 12px;
        max-height: 250px;
        overflow-y: auto;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .list-group-item {
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(200, 170, 110, 0.2);
        color: var(--neutral-light);
        margin-bottom: 0.5rem;
        border-radius: 6px;
        padding: 0.75rem;
    }

    .chat-section {
        background: rgba(0,0,0,0.4);
        border-top: 2px solid rgba(200, 170, 110, 0.3);
        padding: 2rem;
        border-radius: 15px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    .chat-section h5 {
        color: var(--piltover-accent);
        font-family: 'Orbitron', monospace;
        font-weight: 600;
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .messages-container {
        height: 300px;
        overflow-y: auto;
        background: rgba(0,0,0,0.5);
        border: 1px solid rgba(200, 170, 110, 0.3);
        padding: 1rem;
        border-radius: 10px;
        backdrop-filter: blur(10px);
        box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
    }

    .message {
        color: var(--neutral-light);
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(200, 170, 110, 0.1);
        font-family: 'Rajdhani', sans-serif;
    }

    .alert {
        border-radius: 10px;
        border: none;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        font-family: 'Rajdhani', sans-serif;
        font-weight: 500;
    }

    .alert-success {
        background: rgba(0, 212, 170, 0.2);
        color: var(--zaun-glow);
        border-left: 4px solid var(--zaun-accent);
    }

    .alert-danger {
        background: rgba(255, 0, 127, 0.2);
        color: #ff6b9d;
        border-left: 4px solid var(--shimmer-pink);
    }

    .alert-info {
        background: rgba(5, 150, 170, 0.2);
        color: var(--hextech-blue);
        border-left: 4px solid var(--arcane-blue);
    }

    .alert-warning {
        background: rgba(200, 170, 110, 0.2);
        color: var(--piltover-glow);
        border-left: 4px solid var(--piltover-accent);
    }

    /* Instructions Panel */
    .instructions-panel {
        background: rgba(0,0,0,0.4);
        border: 1px solid rgba(200, 170, 110, 0.3);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        backdrop-filter: blur(15px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        animation: slideInUp 0.6s ease-out;
    }

    .instruction-header h3 {
        font-family: 'Orbitron', monospace;
        color: var(--piltover-accent);
        text-align: center;
        margin-bottom: 2rem;
        font-size: 1.8rem;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    .step-by-step {
        margin-bottom: 2rem;
    }

    .instruction-step {
        display: flex;
        align-items: flex-start;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: rgba(0,0,0,0.2);
        border-radius: 12px;
        border-left: 4px solid var(--zaun-accent);
        transition: all 0.3s ease;
    }

    .instruction-step:hover {
        background: rgba(0,0,0,0.3);
        transform: translateX(5px);
        box-shadow: 0 4px 15px rgba(0, 212, 170, 0.2);
    }

    .step-number {
        background: linear-gradient(45deg, var(--zaun-accent), var(--zaun-glow));
        color: var(--neutral-dark);
        width: 3rem;
        height: 3rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.2rem;
        margin-right: 1rem;
        flex-shrink: 0;
        box-shadow: 0 4px 15px rgba(0, 212, 170, 0.4);
    }

    .step-content h4 {
        color: var(--piltover-accent);
        font-family: 'Orbitron', monospace;
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
    }

    .step-content p {
        color: var(--neutral-light);
        opacity: 0.9;
        line-height: 1.5;
        margin: 0;
    }

    .role-preview {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-top: 2rem;
    }

    .role-card {
        padding: 1.5rem;
        border-radius: 15px;
        backdrop-filter: blur(10px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        position: relative;
        overflow: hidden;
    }

    .piltover-preview {
        background: linear-gradient(135deg, var(--piltover-primary) 0%, var(--piltover-secondary) 100%);
        border: 2px solid var(--piltover-accent);
    }

    .zaunite-preview {
        background: linear-gradient(135deg, var(--zaun-dark) 0%, var(--zaun-primary) 100%);
        border: 2px solid var(--zaun-accent);
    }

    .role-card h4 {
        font-family: 'Orbitron', monospace;
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .preview-word {
        font-family: 'Orbitron', monospace;
        font-size: 2rem;
        font-weight: 900;
        letter-spacing: 0.3em;
        text-align: center;
        padding: 1rem;
        background: rgba(0,0,0,0.4);
        border-radius: 8px;
        margin: 1rem 0;
        text-transform: uppercase;
    }

    .preview-clues {
        list-style: none;
        padding: 0;
    }

    .preview-clues li {
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        font-size: 0.9rem;
    }

    /* Success Animation */
    .success-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: radial-gradient(circle, rgba(0, 212, 170, 0.3) 0%, rgba(0, 0, 0, 0.8) 70%);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: successFadeIn 0.5s ease-out;
    }

    .success-content {
        text-align: center;
        animation: successBounce 0.8s ease-out;
    }

    .success-title {
        font-family: 'Orbitron', monospace;
        font-size: 4rem;
        color: var(--zaun-glow);
        text-shadow: 0 0 30px var(--zaun-accent);
        margin-bottom: 1rem;
        animation: successPulse 2s ease-in-out infinite;
    }

    .success-message {
        font-family: 'Rajdhani', sans-serif;
        font-size: 1.5rem;
        color: var(--neutral-light);
        margin-bottom: 2rem;
    }

    .word-transition {
        animation: wordTransition 2s ease-in-out;
    }

    @@keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @@keyframes successFadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @@keyframes successBounce {
        0% { transform: scale(0.3) translateY(50px); opacity: 0; }
        50% { transform: scale(1.1) translateY(-10px); opacity: 1; }
        100% { transform: scale(1) translateY(0); opacity: 1; }
    }

    @@keyframes successPulse {
        0%, 100% { transform: scale(1); filter: brightness(1); }
        50% { transform: scale(1.05); filter: brightness(1.2); }
    }

    @@keyframes wordTransition {
        0% { opacity: 1; transform: scale(1); }
        25% { opacity: 0; transform: scale(0.8) rotateY(90deg); }
        75% { opacity: 0; transform: scale(0.8) rotateY(-90deg); }
        100% { opacity: 1; transform: scale(1) rotateY(0deg); }
    }

    /* Connection Guidance */
    .connection-guidance {
        background: rgba(5, 150, 170, 0.1);
        border: 1px solid var(--hextech-blue);
        border-radius: 10px;
        padding: 1rem;
        margin: 1rem 0;
        animation: pulse 2s ease-in-out infinite alternate;
    }

    .waiting-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--zaun-accent);
        font-weight: 600;
    }

    .loading-dots {
        display: inline-flex;
        gap: 0.2rem;
    }

    .loading-dot {
        width: 4px;
        height: 4px;
        background: var(--zaun-accent);
        border-radius: 50%;
        animation: loadingDot 1.4s ease-in-out infinite both;
    }

    .loading-dot:nth-child(1) { animation-delay: -0.32s; }
    .loading-dot:nth-child(2) { animation-delay: -0.16s; }

    @@keyframes loadingDot {
        0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
    }

    /* Responsive Design */
    @@media (max-width: 768px) {
        .game-title {
            font-size: 2.5rem;
        }
        
        .word-display {
            font-size: 2.5rem;
            letter-spacing: 0.2em;
        }
        
        .player-role {
            font-size: 1.5rem;
        }
        
        .container {
            padding: 1rem;
        }
        
        .game-section, .game-setup, .chat-section, .instructions-panel {
            padding: 1.5rem;
        }

        .role-preview {
            grid-template-columns: 1fr;
        }

        .success-title {
            font-size: 2.5rem;
        }

        .instruction-step {
            flex-direction: column;
            text-align: center;
        }

        .step-number {
            margin: 0 0 1rem 0;
        }
    }
</style>

@code {
    [Parameter] public string? Parameters { get; set; }
    
    private HubConnection? hubConnection;
    private List<string> messages = new();
    private string roomId = "";
    private string playerName = "";
    private string messageInput = "";
    private string currentGuess = "";
    private string gameStatus = "";
    private string latestHint = "";
    
    // Game state
    private bool inGame = false;
    private PlayerView? playerView;
    private GameState? gameState;
    
    // Animation state
    private bool showSuccessAnimation = false;
    private string successMessage = "";
    private bool wordTransitioning = false;
    private string clueAnimationClass = "";

    protected override async Task OnInitializedAsync()
    {
        // Parse URL parameters if provided
        ParseUrlParameters();
        
        // Auto-connect and join if parameters are provided
        await InitializeConnection();
        
        if (!string.IsNullOrEmpty(roomId) && !string.IsNullOrEmpty(playerName))
        {
            await AutoConnect();
        }
    }

    private void ParseUrlParameters()
    {
        if (string.IsNullOrEmpty(Parameters)) return;
        
        try
        {
            var uri = new Uri(Navigation.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
            
            var role = query["role"];
            var avatar = query["avatar"];
            var name = query["name"];
            var squad = query["squad"];
            
            if (!string.IsNullOrEmpty(name))
                playerName = Uri.UnescapeDataString(name);
            
            if (!string.IsNullOrEmpty(squad))
                roomId = Uri.UnescapeDataString(squad);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error parsing URL parameters: {ex.Message}");
        }
    }

    private async Task InitializeConnection()
    {
        hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/gamehub"))
            .Build();

        // Room management events
        hubConnection.On<string, string>("PlayerJoined", (name, connectionId) =>
        {
            var message = $"{DateTime.Now:HH:mm:ss} - {name} joined the room";
            messages.Add(message);
            InvokeAsync(StateHasChanged);
        });

        hubConnection.On<string, string>("PlayerLeft", (name, connectionId) =>
        {
            var message = $"{DateTime.Now:HH:mm:ss} - {name} left the room";
            messages.Add(message);
            InvokeAsync(StateHasChanged);
        });

        hubConnection.On<string, string>("ReceiveMessage", (name, message) =>
        {
            var formattedMessage = $"{DateTime.Now:HH:mm:ss} - {name}: {message}";
            messages.Add(formattedMessage);
            InvokeAsync(StateHasChanged);
        });

        // Code Cracker game events
        hubConnection.On<string, PlayerViewData>("CodeCrackerGameJoined", (role, view) =>
        {
            playerView = new PlayerView
            {
                Role = view.Role,
                DisplayName = view.DisplayName,
                Instruction = view.Instruction,
                DistortedWord = view.DistortedWord,
                Definition = view.Definition,
                GermanTranslation = view.GermanTranslation,
                Synonym = view.Synonym,
                AttemptHistory = view.AttemptHistory
            };
            inGame = true;
            gameStatus = $"Joined game as {role}. Waiting for opponent...";
            messages.Add($"{DateTime.Now:HH:mm:ss} - You joined as {role}");
            InvokeAsync(StateHasChanged);
        });

        hubConnection.On("CodeCrackerGameFull", () =>
        {
            gameStatus = "Game is full! Cannot join.";
            messages.Add($"{DateTime.Now:HH:mm:ss} - Game is full");
            InvokeAsync(StateHasChanged);
        });

        hubConnection.On<GameStateData>("CodeCrackerGameStateUpdated", (state) =>
        {
            gameState = new GameState
            {
                CurrentWordIndex = state.CurrentWordIndex,
                TotalWords = state.TotalWords,
                IsCompleted = state.IsCompleted,
                Score = state.Score,
                HintsUsed = state.HintsUsed,
                PlayerCount = state.PlayerCount,
                PlayersNeeded = state.PlayersNeeded
            };
            
            if (gameState?.PlayerCount == 2 && gameState?.IsCompleted == false)
            {
                gameStatus = "Both players connected! Start guessing!";
            }
            else if (gameState?.PlayerCount < 2)
            {
                gameStatus = "Waiting for opponent...";
            }
            
            InvokeAsync(StateHasChanged);
        });

        hubConnection.On<PlayerViewData>("CodeCrackerPlayerViewUpdated", (view) =>
        {
            InvokeAsync(async () =>
            {
                // For Piltover - trigger word transition
                if (view.Role == "Piltover")
                {
                    wordTransitioning = true;
                    StateHasChanged();
                    await Task.Delay(250);
                }
                // For Zaunite - trigger clue fly-out
                else if (view.Role == "Zaunite")
                {
                    clueAnimationClass = "updating";
                    StateHasChanged();
                    await Task.Delay(300); // Wait for fly-out
                }
                
                // Update the content
                playerView = new PlayerView
                {
                    Role = view.Role,
                    DisplayName = view.DisplayName,
                    Instruction = view.Instruction,
                    DistortedWord = view.DistortedWord,
                    Definition = view.Definition,
                    GermanTranslation = view.GermanTranslation,
                    Synonym = view.Synonym,
                    AttemptHistory = view.AttemptHistory
                };
                
                // Trigger fly-in animations
                if (view.Role == "Piltover")
                {
                    await Task.Delay(1750);
                    wordTransitioning = false;
                }
                else if (view.Role == "Zaunite")
                {
                    clueAnimationClass = "updated";
                    StateHasChanged();
                    await Task.Delay(800); // Wait for staggered fly-in
                    clueAnimationClass = "";
                }
                
                StateHasChanged();
            });
        });

        hubConnection.On<string, int, int>("CodeCrackerGameCompleted", (message, score, wordsCompleted) =>
        {
            gameStatus = $"üéâ {message} - Words completed: {wordsCompleted}";
            messages.Add($"{DateTime.Now:HH:mm:ss} - Game completed! Final score: {score}");
            InvokeAsync(StateHasChanged);
        });

        hubConnection.On<string>("CodeCrackerInvalidGuess", (message) =>
        {
            gameStatus = $"‚ùå {message}";
            InvokeAsync(StateHasChanged);
        });

        hubConnection.On<string>("CodeCrackerCorrectGuess", (message) =>
        {
            // Show success animation
            successMessage = message;
            showSuccessAnimation = true;
            InvokeAsync(StateHasChanged);
            
            // Auto-dismiss after 3 seconds
            InvokeAsync(async () =>
            {
                await Task.Delay(3000);
                showSuccessAnimation = false;
                StateHasChanged();
            });
        });

        hubConnection.On<string>("CodeCrackerHintReceived", (hint) =>
        {
            latestHint = hint;
            messages.Add($"{DateTime.Now:HH:mm:ss} - Hint received: {hint}");
            InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();
    }

    private async Task AutoConnect()
    {
        try
        {
            // Small delay to ensure connection is established
            await Task.Delay(500);
            
            if (IsConnected && !string.IsNullOrEmpty(roomId) && !string.IsNullOrEmpty(playerName))
            {
                await JoinRoom();
                await Task.Delay(200); // Brief delay between operations
                await JoinGame();
                
                gameStatus = "Auto-connecting to your squad...";
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Auto-connect failed: {ex.Message}");
        }
    }

    private async Task JoinRoom()
    {
        if (hubConnection is not null && !string.IsNullOrEmpty(roomId) && !string.IsNullOrEmpty(playerName))
        {
            await hubConnection.SendAsync("JoinRoom", roomId, playerName);
            messages.Add($"{DateTime.Now:HH:mm:ss} - You joined room: {roomId}");
        }
    }

    private async Task LeaveRoom()
    {
        if (hubConnection is not null && !string.IsNullOrEmpty(roomId))
        {
            await hubConnection.SendAsync("LeaveRoom", roomId, playerName);
            messages.Add($"{DateTime.Now:HH:mm:ss} - You left room: {roomId}");
            inGame = false;
            playerView = null;
            gameState = null;
            gameStatus = "";
            latestHint = "";
        }
    }

    private async Task JoinGame()
    {
        if (hubConnection is not null && !string.IsNullOrEmpty(roomId) && !string.IsNullOrEmpty(playerName))
        {
            await hubConnection.SendAsync("JoinCodeCrackerGame", roomId, playerName);
        }
    }

    private async Task SubmitGuess()
    {
        if (hubConnection is not null && !string.IsNullOrEmpty(roomId) && !string.IsNullOrEmpty(currentGuess))
        {
            await hubConnection.SendAsync("SubmitCodeCrackerGuess", roomId, currentGuess);
            currentGuess = "";
            latestHint = ""; // Clear hint after guess
        }
    }

    private async Task RequestHint()
    {
        if (hubConnection is not null && !string.IsNullOrEmpty(roomId))
        {
            await hubConnection.SendAsync("RequestCodeCrackerHint", roomId);
        }
    }

    private async Task RestartGame()
    {
        if (hubConnection is not null && !string.IsNullOrEmpty(roomId))
        {
            await hubConnection.SendAsync("RestartCodeCrackerGame", roomId);
            gameStatus = "Game restarted!";
            latestHint = "";
        }
    }

    private async Task SendMessage()
    {
        if (hubConnection is not null && !string.IsNullOrEmpty(messageInput) && !string.IsNullOrEmpty(roomId))
        {
            await hubConnection.SendAsync("SendMessageToRoom", roomId, playerName, messageInput);
            messageInput = "";
        }
    }

    private string GetRoleClass()
    {
        return playerView?.Role?.ToLower() ?? "";
    }

    private string GetStatusClass()
    {
        if (gameStatus.Contains("Correct") || gameStatus.Contains("üéâ"))
            return "alert-success";
        else if (gameStatus.Contains("‚ùå") || gameStatus.Contains("Incorrect"))
            return "alert-danger";
        else
            return "alert-info";
    }

    public bool IsConnected =>
        hubConnection?.State == HubConnectionState.Connected;

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }

    // Client-side data classes
    public class PlayerView
    {
        public string Role { get; set; } = "";
        public string DisplayName { get; set; } = "";
        public string Instruction { get; set; } = "";
        public string? DistortedWord { get; set; }
        public string? Definition { get; set; }
        public string? GermanTranslation { get; set; }
        public string? Synonym { get; set; }
        public List<string> AttemptHistory { get; set; } = new();
    }

    public class GameState
    {
        public int CurrentWordIndex { get; set; }
        public int TotalWords { get; set; }
        public bool IsCompleted { get; set; }
        public int Score { get; set; }
        public int HintsUsed { get; set; }
        public int PlayerCount { get; set; }
        public int PlayersNeeded { get; set; }
    }
}