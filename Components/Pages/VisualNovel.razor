@page "/visual-novel"
@page "/visual-novel/{theme}"
@using Arcane_Coop.Models
@inject IJSRuntime JSRuntime

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Cinzel:wght@400;600;700&family=Rajdhani:wght@300;400;600;700&display=swap" rel="stylesheet">

<script>
    window.preloadImage = function(src) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve();
            img.onerror = () => reject(new Error(`Failed to load image: ${src}`));
            img.src = src;
        });
    };
</script>

<div class="visual-novel @GetThemeClass()">
    @if (currentScene != null)
    {
        <!-- Background -->
        <div class="scene-background @GetBackgroundClass() @GetBackgroundTransitionClass()">
            @if (!string.IsNullOrEmpty(GetCurrentBackgroundImage()))
            {
                <img src="@GetCurrentBackgroundImage()" alt="Scene background" class="background-image" />
            }
            @if (isBackgroundTransitioning && !string.IsNullOrEmpty(nextBackgroundImage))
            {
                <img src="@nextBackgroundImage" alt="Next background" class="background-image background-transition-target" />
            }
            <div class="background-overlay"></div>
            <div class="atmospheric-effects"></div>
        </div>

        <!-- Character Layer -->
        <div class="characters-layer @GetLayoutClass()">
            @if (currentScene.Layout == SceneLayout.SingleCenter && GetCurrentSpeaker() != null)
            {
                <div class="character-container center-character @(GetCurrentSpeaker()?.IsActive == true ? "active" : "")">
                    <div class="character-portrait">
                        <img src="@GetCurrentSpeaker()?.GetCurrentImagePath()" alt="@GetCurrentSpeaker()?.Name (@GetCurrentSpeaker()?.CurrentExpression)" class="portrait-image" />
                        <div class="character-glow"></div>
                    </div>
                </div>
            }
            else if (currentScene.Layout == SceneLayout.DualCharacters)
            {
                @foreach (var character in currentScene.Characters.Take(2).Where(c => c.IsVisible))
                {
                    <div class="character-container @GetCharacterPositionClass(character) @(character.IsActive ? "active" : "inactive")">
                        <div class="character-portrait">
                            <img src="@character.GetCurrentImagePath()" alt="@character.Name (@character.CurrentExpression)" class="portrait-image" />
                            <div class="character-glow"></div>
                        </div>
                    </div>
                }
            }
            else if (currentScene.Layout == SceneLayout.FourCharacters)
            {
                @foreach (var character in currentScene.Characters.Take(4).Where(c => c.IsVisible))
                {
                    <div class="character-container @GetCharacterPositionClass(character) @(character.IsActive ? "active" : "inactive")">
                        <div class="character-portrait">
                            <img src="@character.GetCurrentImagePath()" alt="@character.Name (@character.CurrentExpression)" class="portrait-image" />
                            <div class="character-glow"></div>
                        </div>
                    </div>
                }
            }
            else if (currentScene.Layout == SceneLayout.FiveCharacters)
            {
                @foreach (var character in currentScene.Characters.Take(5).Where(c => c.IsVisible))
                {
                    <div class="character-container @GetCharacterPositionClass(character) @(character.IsActive ? "active" : "inactive")">
                        <div class="character-portrait">
                            <img src="@character.GetCurrentImagePath()" alt="@character.Name (@character.CurrentExpression)" class="portrait-image" />
                            <div class="character-glow"></div>
                        </div>
                    </div>
                }
            }
        </div>

        <!-- Dialogue Box -->
        <div class="dialogue-section">
            <div class="dialogue-box @GetDialogueBoxClass()">
                <!-- Character Name -->
                @if (config.ShowCharacterNames && GetCurrentSpeaker() != null)
                {
                    <div class="character-name-tag @GetNameTagClass()">
                        <span class="character-name">@GetCurrentSpeaker()?.DisplayName</span>
                        <div class="name-tag-decoration"></div>
                    </div>
                }

                <!-- Dialogue Text Container -->
                <div class="dialogue-content">
                    <div class="dialogue-text-container">
                        <div class="dialogue-text @GetTextAnimationClass()" @ref="dialogueTextElement">
                            @((MarkupString)GetFormattedText())
                        </div>
                        
                        @* Removed blinking cursor - was annoying *@
                    </div>
                </div>
            </div>
            
            <!-- Control Buttons - Now Outside Dialogue Box -->
            <div class="dialogue-controls-external">
                @if (config.ShowSkipButton && !state.IsTextFullyDisplayed)
                {
                    <button class="control-btn skip-btn @GetControlButtonClass()" @onclick="SkipText" title="Skip to end of text">
                        <span class="btn-icon">⏭️</span>
                        <span class="btn-text">Skip</span>
                        <div class="btn-effect"></div>
                    </button>
                }

                @if (config.ShowContinueButton && state.IsTextFullyDisplayed && !IsLastDialogue())
                {
                    <button class="control-btn continue-btn @GetControlButtonClass()" @onclick="ContinueToNext" title="Continue to next dialogue">
                        <span class="btn-icon">▶️</span>
                        <span class="btn-text">Continue</span>
                        <div class="btn-effect"></div>
                    </button>
                }
            </div>
        </div>
    }
    else
    {
        <div class="loading-screen @GetThemeClass()">
            <div class="loading-content">
                <div class="loading-spinner @GetSpinnerClass()"></div>
                <h2>Loading Visual Novel...</h2>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public string? Theme { get; set; }
    [Parameter] public VisualNovelScene? Scene { get; set; }
    [Parameter] public VisualNovelConfig? Configuration { get; set; }
    [Parameter] public EventCallback<VisualNovelState> OnStateChanged { get; set; }
    [Parameter] public EventCallback OnSceneComplete { get; set; }

    private VisualNovelConfig config = new();
    private VisualNovelState state = new();
    private VisualNovelScene? currentScene;
    private DialogueLine? currentDialogue;
    private ElementReference dialogueTextElement;
    
    private Timer? typewriterTimer;
    private CancellationTokenSource? cancellationTokenSource;
    private int currentTextIndex = 0;
    private string displayedText = "";
    private bool isDisposed = false;
    private bool isTextAnimationActive = false;
    private readonly object animationLock = new();

    // Background management
    private string? currentBackgroundImage;
    private string? nextBackgroundImage;
    private bool isBackgroundTransitioning = false;
    private HashSet<string> preloadedBackgrounds = new();
    private readonly object backgroundLock = new();
    private string? lastSceneId = null;

    protected override async Task OnInitializedAsync()
    {
        // Initialize configuration
        if (Configuration != null)
            config = Configuration;
        
        // Set theme from parameter
        if (!string.IsNullOrEmpty(Theme))
        {
            if (Enum.TryParse<NovelTheme>(Theme, true, out var themeEnum))
                config.Theme = themeEnum;
        }

        // Initialize scene
        if (Scene != null)
        {
            // Check if this is a new scene
            if (Scene.Id != lastSceneId)
            {
                currentBackgroundImage = null; // Reset persistent background for new scene
                lastSceneId = Scene.Id;
            }
            
            currentScene = Scene;
            state.CurrentSceneId = Scene.Id;
            await StartDialogue();
        }
        else
        {
            // Load demo scene if no scene provided
            currentScene = CreateDemoScene();
            if (currentScene.Id != lastSceneId)
            {
                currentBackgroundImage = null; // Reset persistent background for new scene
                lastSceneId = currentScene.Id;
            }
            await StartDialogue();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Small delay to ensure proper rendering before starting text animation
            await Task.Delay(100);
            if (currentDialogue != null && !isDisposed)
            {
                await StartTextAnimation();
            }
        }
    }

    private async Task StartDialogue()
    {
        if (currentScene == null || !currentScene.DialogueLines.Any()) return;
        
        currentDialogue = currentScene.DialogueLines[state.CurrentDialogueIndex];
        
        // Initialize background
        await InitializeBackground();
        
        UpdateCharacterStates();
        await InvokeStateChanged();
    }

    private async Task StartTextAnimation()
    {
        if (currentDialogue == null || isDisposed) return;

        lock (animationLock)
        {
            if (isTextAnimationActive)
            {
                // Stop any current animation
                StopCurrentAnimation();
            }
            isTextAnimationActive = true;
        }

        // Ensure we start with completely clean state
        ResetTextState();
        
        // Force immediate UI update to clear any old text
        StateHasChanged();
        await Task.Delay(20); // Slightly longer delay to ensure render

        try
        {
            switch (currentDialogue.AnimationType)
            {
                case TextAnimationType.Typewriter:
                    await StartTypewriterEffect();
                    break;
                case TextAnimationType.Instant:
                    displayedText = currentDialogue.Text;
                    state.IsTextFullyDisplayed = true;
                    StateHasChanged();
                    await InvokeStateChanged();
                    break;
                case TextAnimationType.FadeIn:
                case TextAnimationType.SlideUp:
                    displayedText = currentDialogue.Text;
                    state.IsTextFullyDisplayed = true;
                    StateHasChanged();
                    await InvokeStateChanged();
                    break;
            }
        }
        finally
        {
            lock (animationLock)
            {
                isTextAnimationActive = false;
            }
        }
    }

    private async Task StartTypewriterEffect()
    {
        if (currentDialogue == null || isDisposed) return;

        var speed = currentDialogue.TypewriterSpeed > 0 ? currentDialogue.TypewriterSpeed : config.DefaultTypewriterSpeed;
        
        // Clean up previous cancellation token and timer
        StopCurrentAnimation();
        
        // Create new cancellation token for this animation
        cancellationTokenSource = new CancellationTokenSource();
        var token = cancellationTokenSource.Token;

        try
        {
            while (currentTextIndex < currentDialogue.Text.Length && !token.IsCancellationRequested && !isDisposed)
            {
                await InvokeAsync(() =>
                {
                    if (!token.IsCancellationRequested && currentDialogue != null && currentTextIndex < currentDialogue.Text.Length)
                    {
                        displayedText += currentDialogue.Text[currentTextIndex];
                        currentTextIndex++;
                        StateHasChanged();
                    }
                });

                if (!token.IsCancellationRequested)
                {
                    await Task.Delay(speed, token);
                }
            }

            // Animation completed naturally - set state BEFORE releasing the lock
            if (!token.IsCancellationRequested && !isDisposed)
            {
                // Set completion state first
                state.IsTextFullyDisplayed = true;
                await InvokeAsync(StateHasChanged);
                await InvokeStateChanged();
                
                // Auto-continue if enabled
                if (currentDialogue.AutoContinue && !IsLastDialogue() && !token.IsCancellationRequested)
                {
                    await Task.Delay(currentDialogue.AutoContinueDelay, token);
                    if (!token.IsCancellationRequested && !isDisposed)
                    {
                        await InvokeAsync(ContinueToNext);
                    }
                }
            }
        }
        catch (OperationCanceledException)
        {
            // Animation was cancelled - this is expected behavior
        }
        catch (Exception ex)
        {
            // Log error but don't crash the component
            Console.WriteLine($"Typewriter animation error: {ex.Message}");
        }
    }

    private async Task SkipText()
    {
        if (currentDialogue == null || isDisposed) return;
        
        // Prevent multiple skip calls
        if (state.IsTextFullyDisplayed) return;

        lock (animationLock)
        {
            if (!isTextAnimationActive) return; // Nothing to skip
        }

        // Stop current animation cleanly
        StopCurrentAnimation();
        
        // Immediately show full text - ensure complete replacement
        await InvokeAsync(() =>
        {
            if (currentDialogue != null)
            {
                // Use the helper method to ensure complete reset
                ResetTextState();
                displayedText = currentDialogue.Text; // Set fresh text
                state.IsTextFullyDisplayed = true;
                StateHasChanged();
            }
        });
        
        await InvokeStateChanged();
    }

    private async Task ContinueToNext()
    {
        if (isDisposed) return;
        
        if (IsLastDialogue())
        {
            await OnSceneComplete.InvokeAsync();
            return;
        }

        // Stop any current animation before proceeding
        StopCurrentAnimation();
        
        state.CurrentDialogueIndex++;
        currentDialogue = currentScene?.DialogueLines[state.CurrentDialogueIndex];
        
        // Handle background change for new dialogue
        await HandleBackgroundTransition();
        
        UpdateCharacterStates();
        
        // Reset state for new dialogue
        ResetTextState();
        StateHasChanged();
        
        // Small delay to ensure clean state transition
        await Task.Delay(50);
        await StartTextAnimation();
    }


    private void UpdateCharacterStates()
    {
        if (currentScene == null || currentDialogue == null) return;

        // Reset all characters to inactive and default expression
        foreach (var character in currentScene.Characters)
        {
            character.IsActive = false;
            character.CurrentExpression = CharacterExpression.Default;
        }

        // Set current speaker as active
        var speaker = currentScene.Characters.FirstOrDefault(c => c.Id == currentDialogue.CharacterId);
        if (speaker != null)
        {
            speaker.IsActive = true;
            
            // Reveal character if they were hidden until first line
            if (speaker.HiddenUntilFirstLine && !speaker.IsVisible)
            {
                speaker.IsVisible = true;
            }
            
            // Update speaker expression if specified
            if (currentDialogue.SpeakerExpression.HasValue)
                speaker.CurrentExpression = currentDialogue.SpeakerExpression.Value;
        }

        // Update expressions for other characters if specified (these override the default)
        foreach (var expressionChange in currentDialogue.CharacterExpressions)
        {
            var character = currentScene.Characters.FirstOrDefault(c => c.Id == expressionChange.Key);
            if (character != null)
                character.CurrentExpression = expressionChange.Value;
        }
        
        // Update positions for characters if specified
        foreach (var positionChange in currentDialogue.CharacterPositions)
        {
            var character = currentScene.Characters.FirstOrDefault(c => c.Id == positionChange.Key);
            if (character != null)
                character.Position = positionChange.Value;
        }
        
        // Update visibility for characters if specified
        foreach (var visibilityChange in currentDialogue.CharacterVisibility)
        {
            var character = currentScene.Characters.FirstOrDefault(c => c.Id == visibilityChange.Key);
            if (character != null)
            {
                character.IsVisible = visibilityChange.Value;
            }
        }
    }

    private VisualNovelCharacter? GetCurrentSpeaker()
    {
        if (currentScene == null || currentDialogue == null) return null;
        return currentScene.Characters.FirstOrDefault(c => c.Id == currentDialogue.CharacterId);
    }

    private bool IsLastDialogue()
    {
        return currentScene == null || state.CurrentDialogueIndex >= currentScene.DialogueLines.Count - 1;
    }

    private async Task InvokeStateChanged()
    {
        await OnStateChanged.InvokeAsync(state);
    }

    private string GetFormattedText()
    {
        return displayedText.Replace("\n", "<br/>");
    }
    

    // CSS Class Methods
    private string GetThemeClass() => config.Theme.ToString().ToLower();
    private string GetBackgroundClass() => $"background-{config.Theme.ToString().ToLower()}";
    private string GetLayoutClass() => currentScene?.Layout.ToString().ToLower() ?? "single";
    private string GetDialogueBoxClass() => $"dialogue-{config.Theme.ToString().ToLower()}";
    private string GetNameTagClass() => $"name-tag-{config.Theme.ToString().ToLower()}";
    private string GetTextAnimationClass() => currentDialogue?.AnimationType.ToString().ToLower() ?? "typewriter";
    private string GetCursorClass() => $"cursor-{config.Theme.ToString().ToLower()}";
    private string GetControlButtonClass() => $"control-{config.Theme.ToString().ToLower()}";
    private string GetSpinnerClass() => $"spinner-{config.Theme.ToString().ToLower()}";
    
    private string GetCharacterPositionClass(VisualNovelCharacter character)
    {
        // Convert enum to CSS class name, handling underscores
        var position = character.Position.ToString();
        
        // Handle the 5-character layout positions
        if (position.Contains("_5Characters"))
        {
            // Convert "Leftmost_5Characters" to "leftmost-5characters-character"
            return position.Replace("_5Characters", "-5characters").ToLower() + "-character";
        }
        
        // Handle the 4-character layout positions
        if (position.Contains("_4Characters"))
        {
            // Convert "Leftmost_4Characters" to "leftmost-4characters-character"
            return position.Replace("_4Characters", "-4characters").ToLower() + "-character";
        }
        
        // Handle standard positions
        return position.ToLower() + "-character";
    }

    private VisualNovelScene CreateDemoScene()
    {
        var scene = new VisualNovelScene
        {
            Name = "Demo Scene",
            Layout = SceneLayout.DualCharacters,
            Theme = config.Theme
        };

        // Add demo characters based on theme
        if (config.Theme == NovelTheme.Piltover)
        {
            scene.Characters.AddRange(new[]
            {
                new VisualNovelCharacter
                {
                    Id = "jayce",
                    Name = "Jayce",
                    DisplayName = "Jayce Talis",
                    ImagePath = "/images/Jayce.jpeg",
                    Position = CharacterPosition.Left,
                    ThemeColor = "#c8aa6e"
                },
                new VisualNovelCharacter
                {
                    Id = "viktor",
                    Name = "Viktor",
                    DisplayName = "Viktor",
                    ImagePath = "/images/Viktor.jpeg",
                    Position = CharacterPosition.Right,
                    ThemeColor = "#0596aa"
                }
            });

            scene.DialogueLines.AddRange(new[]
            {
                new DialogueLine
                {
                    CharacterId = "jayce",
                    Text = "The Hextech research shows promising results, Viktor. We're on the verge of a breakthrough that could change everything.",
                    AnimationType = TextAnimationType.Typewriter,
                    TypewriterSpeed = 40
                },
                new DialogueLine
                {
                    CharacterId = "viktor",
                    Text = "Indeed, Jayce. But we must consider the implications. Progress without wisdom is merely chaos in disguise.",
                    AnimationType = TextAnimationType.Typewriter,
                    TypewriterSpeed = 45
                },
                new DialogueLine
                {
                    CharacterId = "jayce",
                    Text = "You're right to be cautious. But think of what we could accomplish - clean energy for all of Piltover, maybe even beyond.",
                    AnimationType = TextAnimationType.Typewriter,
                    TypewriterSpeed = 40
                }
            });
        }
        else
        {
            scene.Characters.AddRange(new[]
            {
                new VisualNovelCharacter
                {
                    Id = "vi",
                    Name = "Vi",
                    DisplayName = "Vi",
                    ImagePath = "/images/Vi.jpeg",
                    Position = CharacterPosition.Left,
                    ThemeColor = "#00d4aa"
                },
                new VisualNovelCharacter
                {
                    Id = "caitlyn",
                    Name = "Caitlyn",
                    DisplayName = "Sheriff Caitlyn",
                    ImagePath = "/images/Cait.jpeg",
                    Position = CharacterPosition.Right,
                    ThemeColor = "#ff007f"
                }
            });

            scene.DialogueLines.AddRange(new[]
            {
                new DialogueLine
                {
                    CharacterId = "vi",
                    Text = "Cupcake, you seeing this? The chemical levels down here are off the charts. Something big is going down.",
                    AnimationType = TextAnimationType.Typewriter,
                    TypewriterSpeed = 35
                },
                new DialogueLine
                {
                    CharacterId = "caitlyn",
                    Text = "I see it, Vi. The readings match what we found at the warehouse. Someone's been manufacturing Shimmer on an industrial scale.",
                    AnimationType = TextAnimationType.Typewriter,
                    TypewriterSpeed = 50
                },
                new DialogueLine
                {
                    CharacterId = "vi",
                    Text = "Then we better move fast. In Zaun, when the Chem-Barons get desperate, innocent people pay the price.",
                    AnimationType = TextAnimationType.Typewriter,
                    TypewriterSpeed = 35
                }
            });
        }

        return scene;
    }

    private void StopCurrentAnimation()
    {
        typewriterTimer?.Dispose();
        typewriterTimer = null;
        
        cancellationTokenSource?.Cancel();
        cancellationTokenSource?.Dispose();
        cancellationTokenSource = null;
    }
    
    private void ResetTextState()
    {
        displayedText = "";
        currentTextIndex = 0;
        state.IsTextFullyDisplayed = false;
    }

    // Background Management Methods
    private Task InitializeBackground()
    {
        if (currentScene == null) return Task.CompletedTask;
        
        lock (backgroundLock)
        {
            // Set initial background from scene or first dialogue
            currentBackgroundImage = currentScene.BackgroundImage;
            
            if (currentDialogue?.BackgroundImage != null)
                currentBackgroundImage = currentDialogue.BackgroundImage;
        }
        
        // Preload backgrounds for better performance
        PreloadSceneBackgrounds();
        
        return Task.CompletedTask;
    }

    private async Task HandleBackgroundTransition()
    {
        if (currentDialogue?.BackgroundImage == null) return;
        if (currentDialogue.BackgroundImage == currentBackgroundImage) return;
        
        lock (backgroundLock)
        {
            if (isBackgroundTransitioning) return;
            isBackgroundTransitioning = true;
            nextBackgroundImage = currentDialogue.BackgroundImage;
        }

        try
        {
            // Preload the new background
            await PreloadBackground(nextBackgroundImage);
            
            // Start CSS transition
            StateHasChanged();
            
            // Wait for transition duration
            var duration = currentDialogue.BackgroundTransitionDuration > 0 
                ? currentDialogue.BackgroundTransitionDuration 
                : 1000;
            await Task.Delay(duration);
            
            lock (backgroundLock)
            {
                // Make this background the new persistent default for the scene
                currentBackgroundImage = nextBackgroundImage;
                if (currentScene != null)
                    currentScene.BackgroundImage = nextBackgroundImage;
                nextBackgroundImage = null;
            }
            
            StateHasChanged();
        }
        finally
        {
            lock (backgroundLock)
            {
                isBackgroundTransitioning = false;
            }
        }
    }

    private void PreloadSceneBackgrounds()
    {
        if (currentScene?.DialogueLines == null) return;
        
        var backgroundsToPreload = currentScene.DialogueLines
            .Where(d => !string.IsNullOrEmpty(d.BackgroundImage))
            .Select(d => d.BackgroundImage!)
            .Distinct()
            .Where(bg => !preloadedBackgrounds.Contains(bg))
            .ToList();
            
        if (!string.IsNullOrEmpty(currentScene.BackgroundImage) && 
            !preloadedBackgrounds.Contains(currentScene.BackgroundImage))
        {
            backgroundsToPreload.Add(currentScene.BackgroundImage);
        }

        // Preload up to 3 backgrounds at once to avoid overwhelming the browser
        var batch = backgroundsToPreload.Take(3);
        foreach (var background in batch)
        {
            _ = Task.Run(async () => await PreloadBackground(background));
        }
    }

    private async Task PreloadBackground(string? backgroundPath)
    {
        if (string.IsNullOrEmpty(backgroundPath) || preloadedBackgrounds.Contains(backgroundPath))
            return;

        try
        {
            await JSRuntime.InvokeVoidAsync("preloadImage", backgroundPath);
            preloadedBackgrounds.Add(backgroundPath);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to preload background {backgroundPath}: {ex.Message}");
        }
    }

    private string GetCurrentBackgroundImage()
    {
        // Return the transition target if transitioning, otherwise current persistent background
        return nextBackgroundImage ?? currentBackgroundImage ?? "";
    }

    private string GetBackgroundTransitionClass()
    {
        if (!isBackgroundTransitioning || currentDialogue == null) return "";
        
        return currentDialogue.BackgroundTransition switch
        {
            BackgroundTransitionType.Fade => "background-fade-transition",
            BackgroundTransitionType.CrossFade => "background-crossfade-transition", 
            BackgroundTransitionType.SlideLeft => "background-slide-left-transition",
            BackgroundTransitionType.SlideRight => "background-slide-right-transition",
            BackgroundTransitionType.Instant => "",
            _ => "background-fade-transition"
        };
    }

    public void Dispose()
    {
        isDisposed = true;
        StopCurrentAnimation();
        preloadedBackgrounds.Clear();
    }
}

<style>
/********************************************
 * Visual Novel Container & Base Styling
 ********************************************/
.visual-novel {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    font-family: 'Rajdhani', sans-serif;
    color: #fff;
    display: flex;
    flex-direction: column;
    z-index: 1000;
}

/********************************************
 * Theme-Specific Backgrounds
 ********************************************/
.visual-novel.piltover {
    background: linear-gradient(135deg, #2c1810 0%, #5a4a3a 30%, #c8aa6e 100%);
}

.visual-novel.zaun {
    background: linear-gradient(135deg, #0a1e16 0%, #1a3a2e 30%, #00d4aa 100%);
}

/********************************************
 * Scene Background
 ********************************************/
.scene-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
}

.background-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    filter: brightness(0.8);
}

.background-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.4);
    z-index: 2;
}

.atmospheric-effects {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 3;
    pointer-events: none;
}

.background-piltover .atmospheric-effects {
    background: radial-gradient(circle at 20% 50%, rgba(200, 170, 110, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 215, 0, 0.05) 0%, transparent 50%);
}

.background-zaun .atmospheric-effects {
    background: radial-gradient(circle at 30% 70%, rgba(0, 212, 170, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 70% 30%, rgba(0, 255, 200, 0.05) 0%, transparent 50%);
}

/********************************************
 * Background Transitions
 ********************************************/
.background-image {
    transition: opacity 1s ease-in-out, transform 1s ease-in-out;
}

.background-transition-target {
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1;
}

.scene-background.background-fade-transition .background-image:not(.background-transition-target) {
    opacity: 0;
}

.scene-background.background-crossfade-transition .background-image:not(.background-transition-target) {
    opacity: 0.5;
}

.scene-background.background-slide-left-transition .background-image:not(.background-transition-target) {
    transform: translateX(-100%);
    opacity: 0;
}

.scene-background.background-slide-right-transition .background-image:not(.background-transition-target) {
    transform: translateX(100%);
    opacity: 0;
}

.scene-background.background-slide-left-transition .background-transition-target {
    transform: translateX(0);
    opacity: 1;
    animation: slideInFromRight 1s ease-out;
}

.scene-background.background-slide-right-transition .background-transition-target {
    transform: translateX(0);
    opacity: 1;
    animation: slideInFromLeft 1s ease-out;
}

@@keyframes slideInFromRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@@keyframes slideInFromLeft {
    from {
        transform: translateX(-100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/********************************************
 * Character Layer
 ********************************************/
.characters-layer {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 4;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    
}

.characters-layer.single {
    justify-content: center;
}

.characters-layer.dualcharacters {
    justify-content: space-around;
    padding: 0 5%;
    
}

.character-container {
    position: relative;
    bottom: 25%;
    transition: all 0.6s cubic-bezier(0.25, 0.8, 0.25, 1);
    transform: scale(0.95) translateY(10px);
}

.character-container.active {
    transform: scale(1.05) translateY(0px);
    z-index: 5;
}

.character-container.inactive {
    transform: scale(0.88) translateY(15px);
}

.character-portrait {
    position: relative;
    display: flex;
    align-items: flex-end;
    justify-content: center;
}

.portrait-image {
    max-height: 70vh;
    max-width: 400px;
    object-fit: contain;
    transition: all 0.4s ease-in-out;
    transform-origin: center bottom;
}

/* Active character glow effect for transparent PNGs */
.character-container.active .portrait-image {
    filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.3))
            drop-shadow(0 10px 40px rgba(0, 0, 0, 0.8))
            drop-shadow(0 0 60px rgba(200, 170, 110, 0.2));
}

/* Inactive character subtle shadow */
.character-container.inactive .portrait-image {
    filter: drop-shadow(0 5px 20px rgba(0, 0, 0, 0.6));
    opacity: 0.6;
}

.character-glow {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 120%;
    height: 120%;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1), 
                transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    transform: translate(-50%, -50%) scale(0.8);
    z-index: -1;
}

.character-container.active .character-glow {
    opacity: 0.4;
    transform: translate(-50%, -50%) scale(1);
}

.visual-novel.piltover .character-container.active .character-glow {
    background: radial-gradient(ellipse at center, 
        rgba(200, 170, 110, 0.15) 0%, 
        rgba(200, 170, 110, 0.08) 30%, 
        transparent 70%);
    filter: blur(40px);
}

.visual-novel.zaun .character-container.active .character-glow {
    background: radial-gradient(ellipse at center, 
        rgba(0, 212, 170, 0.15) 0%, 
        rgba(0, 212, 170, 0.08) 30%, 
        transparent 70%);
    filter: blur(40px);
}

/* Enhanced theme-specific portrait shadows */
.visual-novel.piltover .character-container.active .portrait-image {
    filter: drop-shadow(0 0 15px rgba(200, 170, 110, 0.4))
            drop-shadow(0 10px 40px rgba(0, 0, 0, 0.7))
            drop-shadow(0 0 40px rgba(255, 215, 0, 0.15));
}

.visual-novel.zaun .character-container.active .portrait-image {
    filter: drop-shadow(0 0 15px rgba(0, 212, 170, 0.4))
            drop-shadow(0 10px 40px rgba(0, 0, 0, 0.7))
            drop-shadow(0 0 40px rgba(0, 255, 200, 0.15));
}

.left-character {
    align-self: flex-end;
}

.right-character {
    align-self: flex-end;
}

.center-character {
    align-self: flex-end;
}

/* 4-Character Layout Positions */
.leftmost-4characters-character {
    align-self: flex-end;
    transform: translateX(-10%);
}

.left-4characters-character {
    align-self: flex-end;
    transform: translateX(-5%);
}

.right-4characters-character {
    align-self: flex-end;
    transform: translateX(5%);
}

.rightmost-4characters-character {
    align-self: flex-end;
    transform: translateX(10%);
}

/* Adjust character sizing for 4-character layout */
.layout-fourcharacters .character-container .portrait-image {
    max-height: 60vh;
    max-width: 300px;
}

.layout-fourcharacters .character-container {
    bottom: 20%;
    transform: scale(0.85) translateY(10px);
}

.layout-fourcharacters .character-container.active {
    transform: scale(0.95) translateY(0px);
}

.layout-fourcharacters .character-container.inactive {
    transform: scale(0.78) translateY(15px);
}

/* 5-Character Layout Positions */
.leftmost-5characters-character {
    align-self: flex-end;
    transform: translateX(-15%);
}

.left-5characters-character {
    align-self: flex-end;
    transform: translateX(-7.5%);
}

.center-5characters-character {
    align-self: flex-end;
    transform: translateX(0%);
}

.right-5characters-character {
    align-self: flex-end;
    transform: translateX(7.5%);
}

.rightmost-5characters-character {
    align-self: flex-end;
    transform: translateX(15%);
}

/* Adjust character sizing for 5-character layout */
.layout-fivecharacters .character-container .portrait-image {
    max-height: 55vh;
    max-width: 250px;
}

.layout-fivecharacters .character-container {
    bottom: 18%;
    transform: scale(0.75) translateY(10px);
}

.layout-fivecharacters .character-container.active {
    transform: scale(0.85) translateY(0px);
}

.layout-fivecharacters .character-container.inactive {
    transform: scale(0.68) translateY(15px);
}

/********************************************
 * Dialogue Section
 ********************************************/
.dialogue-section {
    position: absolute;
    bottom: 3rem;
    left: 50%;
    transform: translateX(-50%);
    width: 70%;
    max-width: 900px;
    z-index: 6;
}

.dialogue-box {
    position: relative;
    min-height: 200px;
    background: linear-gradient(135deg, 
        rgba(0, 0, 0, 0.92) 0%, 
        rgba(15, 10, 25, 0.88) 50%,
        rgba(0, 0, 0, 0.92) 100%);
    padding: 2.5rem 3rem 2rem 3rem;
    border: none;
    overflow: visible;
    animation: dialogueBoxEntrance 0.8s cubic-bezier(0.25, 0.8, 0.25, 1);
    
    /* Hextech-inspired border design */
    box-shadow: 
        inset 0 0 0 1px rgba(200, 170, 110, 0.8),
        inset 0 0 0 3px rgba(0, 0, 0, 0.9),
        inset 0 0 0 4px rgba(200, 170, 110, 0.4),
        inset 0 0 20px rgba(200, 170, 110, 0.1),
        0 0 50px rgba(0, 0, 0, 0.8),
        0 0 80px rgba(200, 170, 110, 0.15);
    
    /* More dramatic angular corners */
    clip-path: polygon(
        0 15px, 15px 0,
        calc(100% - 15px) 0, 100% 15px,
        100% calc(100% - 15px), calc(100% - 15px) 100%,
        15px 100%, 0 calc(100% - 15px)
    );
}

@@keyframes dialogueBoxEntrance {
    from {
        transform: translateY(50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

/* Subtle corner accents */
.dialogue-box::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: 
        /* Static corner hextech nodes */
        radial-gradient(circle at 3rem 3rem, rgba(200, 170, 110, 0.2) 2px, transparent 3px),
        radial-gradient(circle at calc(100% - 3rem) 3rem, rgba(200, 170, 110, 0.2) 2px, transparent 3px),
        radial-gradient(circle at 3rem calc(100% - 3rem), rgba(200, 170, 110, 0.2) 2px, transparent 3px),
        radial-gradient(circle at calc(100% - 3rem) calc(100% - 3rem), rgba(200, 170, 110, 0.2) 2px, transparent 3px);
    background-size: 10px 10px, 10px 10px, 10px 10px, 10px 10px;
    background-position: top left, top right, bottom left, bottom right;
    background-repeat: no-repeat, no-repeat, no-repeat, no-repeat;
    pointer-events: none;
    opacity: 0.5;
}

/* Static border accent */
.dialogue-box::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, 
        rgba(200, 170, 110, 0.05) 0%, 
        transparent 20%, 
        transparent 80%, 
        rgba(200, 170, 110, 0.05) 100%);
    clip-path: polygon(
        0 15px, 15px 0,
        calc(100% - 15px) 0, 100% 15px,
        100% calc(100% - 15px), calc(100% - 15px) 100%,
        15px 100%, 0 calc(100% - 15px)
    );
    pointer-events: none;
    z-index: -1;
}

.dialogue-piltover {
    background: linear-gradient(135deg, 
        rgba(10, 5, 0, 0.95) 0%, 
        rgba(25, 15, 5, 0.9) 50%,
        rgba(10, 5, 0, 0.95) 100%);
    box-shadow: 
        inset 0 0 0 1px rgba(200, 170, 110, 0.9),
        inset 0 0 0 3px rgba(0, 0, 0, 0.9),
        inset 0 0 0 4px rgba(255, 215, 0, 0.5),
        inset 0 0 30px rgba(255, 215, 0, 0.1),
        0 0 60px rgba(0, 0, 0, 0.8),
        0 0 100px rgba(200, 170, 110, 0.2);
}

.dialogue-piltover::before {
    background-image: 
        /* Enhanced corner patterns for Piltover */
        radial-gradient(circle at 2rem 2rem, rgba(200, 170, 110, 0.25) 1px, transparent 2px),
        radial-gradient(circle at calc(100% - 2rem) 2rem, rgba(200, 170, 110, 0.25) 1px, transparent 2px),
        radial-gradient(circle at 2rem calc(100% - 2rem), rgba(200, 170, 110, 0.25) 1px, transparent 2px),
        radial-gradient(circle at calc(100% - 2rem) calc(100% - 2rem), rgba(200, 170, 110, 0.25) 1px, transparent 2px),
        /* Hextech grid pattern */
        linear-gradient(90deg, rgba(255, 215, 0, 0.15) 1px, transparent 1px),
        linear-gradient(0deg, rgba(255, 215, 0, 0.15) 1px, transparent 1px);
}

.dialogue-zaun {
    background: linear-gradient(135deg, 
        rgba(0, 10, 8, 0.95) 0%, 
        rgba(5, 20, 15, 0.9) 50%,
        rgba(0, 10, 8, 0.95) 100%);
    box-shadow: 
        inset 0 0 0 1px rgba(0, 212, 170, 0.9),
        inset 0 0 0 3px rgba(0, 0, 0, 0.9),
        inset 0 0 0 4px rgba(0, 255, 200, 0.5),
        inset 0 0 30px rgba(0, 255, 200, 0.1),
        0 0 60px rgba(0, 0, 0, 0.8),
        0 0 100px rgba(0, 212, 170, 0.2);
}

.dialogue-zaun::before {
    background-image: 
        /* Underground tech patterns for Zaun */
        radial-gradient(circle at 2rem 2rem, rgba(0, 212, 170, 0.25) 1px, transparent 2px),
        radial-gradient(circle at calc(100% - 2rem) 2rem, rgba(0, 212, 170, 0.25) 1px, transparent 2px),
        radial-gradient(circle at 2rem calc(100% - 2rem), rgba(0, 212, 170, 0.25) 1px, transparent 2px),
        radial-gradient(circle at calc(100% - 2rem) calc(100% - 2rem), rgba(0, 212, 170, 0.25) 1px, transparent 2px),
        /* Chemical grid pattern */
        linear-gradient(90deg, rgba(0, 255, 200, 0.15) 1px, transparent 1px),
        linear-gradient(0deg, rgba(0, 255, 200, 0.15) 1px, transparent 1px);
}

/********************************************
 * Dialogue Controls
 ********************************************/
.dialogue-controls-external {
    position: absolute;
    top: -55px;
    right: 20px;
    display: flex;
    gap: 15px;
    z-index: 100;
}

.control-btn {
    padding: 10px 18px;
    border: none;
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.9) 0%, rgba(30, 30, 30, 0.8) 100%);
    color: #fff;
    font-size: 1rem;
    font-family: 'Orbitron', monospace;
    font-weight: 600;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    animation: buttonEntrance 0.6s ease-out;
    
    /* Arcane-style angular shape */
    clip-path: polygon(0 0, calc(100% - 6px) 0, 100% 6px, 100% 100%, 6px 100%, 0 calc(100% - 6px));
    
    /* Glowing border effect */
    box-shadow: 
        inset 0 0 0 1px rgba(200, 170, 110, 0.5),
        0 0 12px rgba(200, 170, 110, 0.2),
        0 2px 8px rgba(0, 0, 0, 0.3);
}

@@keyframes buttonEntrance {
    from {
        transform: translateX(30px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.control-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, 
        rgba(200, 170, 110, 0.1) 0%, 
        transparent 50%, 
        rgba(200, 170, 110, 0.1) 100%);
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
}

.control-btn:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 
        inset 0 0 0 1px rgba(200, 170, 110, 0.9),
        0 0 25px rgba(200, 170, 110, 0.5),
        0 6px 20px rgba(0, 0, 0, 0.4);
}

.control-btn:hover::before {
    opacity: 1;
}

.control-btn:active {
    transform: translateY(0);
    transition: all 0.1s ease;
}

.control-piltover {
    box-shadow: 
        inset 0 0 0 1px rgba(200, 170, 110, 0.6),
        0 0 15px rgba(200, 170, 110, 0.3),
        0 2px 8px rgba(0, 0, 0, 0.3);
}

.control-piltover::before {
    background: linear-gradient(90deg, 
        rgba(255, 215, 0, 0.15) 0%, 
        transparent 50%, 
        rgba(255, 215, 0, 0.15) 100%);
}

.control-piltover:hover {
    box-shadow: 
        inset 0 0 0 1px rgba(200, 170, 110, 0.9),
        0 0 25px rgba(200, 170, 110, 0.5),
        0 4px 16px rgba(0, 0, 0, 0.4);
}

.control-zaun {
    box-shadow: 
        inset 0 0 0 1px rgba(0, 212, 170, 0.6),
        0 0 15px rgba(0, 212, 170, 0.3),
        0 2px 8px rgba(0, 0, 0, 0.3);
}

.control-zaun::before {
    background: linear-gradient(90deg, 
        rgba(0, 255, 200, 0.15) 0%, 
        transparent 50%, 
        rgba(0, 255, 200, 0.15) 100%);
}

.control-zaun:hover {
    box-shadow: 
        inset 0 0 0 1px rgba(0, 212, 170, 0.9),
        0 0 25px rgba(0, 212, 170, 0.5),
        0 4px 16px rgba(0, 0, 0, 0.4);
}

.btn-effect {
    /* Removed */
}

.btn-icon {
    /* No special styling */
}

.btn-text {
    /* No special styling */
}

/********************************************
 * Character Name Tag
 ********************************************/
.character-name-tag {
    display: inline-block;
    margin-bottom: 1rem;
    padding: 8px 16px;
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.8) 0%, rgba(20, 20, 20, 0.6) 100%);
    border: none;
    font-weight: 700;
    font-size: 1.1rem;
    color: #fff;
    font-family: 'Orbitron', monospace;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    position: relative;
    overflow: hidden;
    animation: nameTagEntrance 0.6s cubic-bezier(0.25, 0.8, 0.25, 1);
    
    /* Arcane-style angular shape */
    clip-path: polygon(0 0, calc(100% - 8px) 0, 100% 8px, 100% 100%, 8px 100%, 0 calc(100% - 8px));
    
    /* Glowing border effect */
    box-shadow: 
        inset 0 0 0 1px rgba(200, 170, 110, 0.6),
        0 0 15px rgba(200, 170, 110, 0.3);
}

@@keyframes nameTagEntrance {
    from {
        transform: translateX(-30px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.character-name-tag::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, 
        rgba(200, 170, 110, 0.1) 0%, 
        transparent 30%, 
        transparent 70%, 
        rgba(200, 170, 110, 0.1) 100%);
    pointer-events: none;
}

.name-tag-piltover {
    box-shadow: 
        inset 0 0 0 1px rgba(200, 170, 110, 0.8),
        0 0 20px rgba(200, 170, 110, 0.4);
    color: rgba(200, 170, 110, 1);
}

.name-tag-piltover::before {
    background: linear-gradient(90deg, 
        rgba(255, 215, 0, 0.15) 0%, 
        transparent 30%, 
        transparent 70%, 
        rgba(255, 215, 0, 0.15) 100%);
}

.name-tag-zaun {
    box-shadow: 
        inset 0 0 0 1px rgba(0, 212, 170, 0.8),
        0 0 20px rgba(0, 212, 170, 0.4);
    color: rgba(0, 212, 170, 1);
}

.name-tag-zaun::before {
    background: linear-gradient(90deg, 
        rgba(0, 255, 200, 0.15) 0%, 
        transparent 30%, 
        transparent 70%, 
        rgba(0, 255, 200, 0.15) 100%);
}

.character-name {
    /* No special styling */
}

.name-tag-decoration {
    /* Removed */
}

/********************************************
 * Dialogue Content
 ********************************************/
.dialogue-content {
    /* No special styling */
}

.dialogue-text-container {
    /* No special styling */
}

.dialogue-text {
    font-size: 1.3rem;
    line-height: 1.6;
    color: #f8f8f8;
    font-family: 'Rajdhani', sans-serif;
    font-weight: 400;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    position: relative;
    z-index: 10;
}

/* Text Animation Classes */
.dialogue-text.typewriter {
    /* Typewriter effect handled by C# code */
}

.dialogue-text.fadein {
    animation: fadeInText 1s ease-in;
}

.dialogue-text.slideup {
    animation: slideUpText 0.8s ease-out;
}

.dialogue-text.instant {
    /* No animation */
}

@@keyframes fadeInText {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@@keyframes slideUpText {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/********************************************
 * Typing Cursor - REMOVED (was annoying)
 ********************************************/

/********************************************
 * Loading Screen
 ********************************************/
.loading-screen {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100vh;
}

.loading-content {
    text-align: center;
    color: #fff;
}

.loading-content h2 {
    font-family: 'Arcane Nine', 'Cinzel', serif;
    font-size: 2rem;
    margin-top: 2rem;
    opacity: 0.8;
}

.loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    border-top-color: #c8aa6e;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

.spinner-piltover {
    border-top-color: #c8aa6e;
}

.spinner-zaun {
    border-top-color: #00d4aa;
}

@@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

/********************************************
 * Responsive Design
 ********************************************/
@@media (max-width: 768px) {
    .dialogue-section {
        width: 85%;
        bottom: 2rem;
    }
    
    .dialogue-box {
        padding: 2rem 2rem 1.5rem 2rem;
        min-height: 160px;
    }
    
    .dialogue-text {
        font-size: 1.1rem;
    }
    
    .character-name-tag {
        font-size: 0.9rem;
        padding: 3px 6px;
    }
    
    .characters-layer.dualcharacters {
        padding: 0 2%;
        padding-bottom: 35%;
    }
    
    .portrait-image {
        max-height: 60vh;
        max-width: 300px;
    }
    
    .control-btn {
        padding: 8px 14px;
        font-size: 0.9rem;
    }
    
    .dialogue-controls-external {
        top: -50px;
        gap: 10px;
        right: 15px;
    }
}

@@media (max-width: 480px) {
    .dialogue-section {
        width: 95%;
        bottom: 1rem;
    }
    
    .dialogue-text {
        font-size: 1rem;
    }
    
    .portrait-image {
        max-height: 50vh;
        max-width: 250px;
    }
    
    .dialogue-box {
        min-height: 140px;
        padding: 1.5rem 1.5rem 1rem 1.5rem;
    }
    
    .character-name-tag {
        font-size: 0.8rem;
    }
    
    .control-btn {
        padding: 6px 12px;
        font-size: 0.8rem;
    }
    
    .dialogue-controls-external {
        top: -45px;
        gap: 8px;
        right: 10px;
    }
}

/********************************************
 * Hardware Acceleration & Performance
 ********************************************/
.character-container,
.dialogue-box,
.control-btn {
    will-change: transform;
    transform: translateZ(0);
}

.portrait-image {
    backface-visibility: hidden;
    perspective: 1000px;
}

/* Smooth scrolling for long dialogue */
.dialogue-text {
    scroll-behavior: smooth;
}
</style>