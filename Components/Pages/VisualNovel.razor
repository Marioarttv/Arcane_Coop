@page "/visual-novel"
@page "/visual-novel/{theme}"
@using Arcane_Coop.Models
@inject IJSRuntime JSRuntime

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Cinzel:wght@400;600;700&family=Rajdhani:wght@300;400;600;700&display=swap" rel="stylesheet">

<div class="visual-novel @GetThemeClass()">
    @if (currentScene != null)
    {
        <!-- Background -->
        <div class="scene-background @GetBackgroundClass()">
            @if (!string.IsNullOrEmpty(currentScene.BackgroundImage))
            {
                <img src="@currentScene.BackgroundImage" alt="Scene background" class="background-image" />
            }
            <div class="background-overlay"></div>
            <div class="atmospheric-effects"></div>
        </div>

        <!-- Character Layer -->
        <div class="characters-layer @GetLayoutClass()">
            @if (currentScene.Layout == SceneLayout.SingleCenter && GetCurrentSpeaker() != null)
            {
                <div class="character-container center-character @(GetCurrentSpeaker()?.IsActive == true ? "active" : "")">
                    <div class="character-portrait">
                        <img src="@GetCurrentSpeaker()?.ImagePath" alt="@GetCurrentSpeaker()?.Name" class="portrait-image" />
                        <div class="character-glow"></div>
                    </div>
                </div>
            }
            else if (currentScene.Layout == SceneLayout.DualCharacters)
            {
                @foreach (var character in currentScene.Characters.Take(2))
                {
                    <div class="character-container @GetCharacterPositionClass(character) @(character.IsActive ? "active" : "inactive")">
                        <div class="character-portrait">
                            <img src="@character.ImagePath" alt="@character.Name" class="portrait-image" />
                            <div class="character-glow"></div>
                        </div>
                    </div>
                }
            }
        </div>

        <!-- Dialogue Box -->
        <div class="dialogue-section">
            <div class="dialogue-box @GetDialogueBoxClass()">


                <!-- Character Name -->
                @if (config.ShowCharacterNames && GetCurrentSpeaker() != null)
                {
                    <div class="character-name-tag @GetNameTagClass()">
                        <span class="character-name">@GetCurrentSpeaker()?.DisplayName</span>
                        <div class="name-tag-decoration"></div>
                    </div>
                }

                <!-- Dialogue Text Container -->
                <div class="dialogue-content">
                    <div class="dialogue-text-container">
                        <div class="dialogue-text @GetTextAnimationClass()" @ref="dialogueTextElement">
                            @((MarkupString)GetFormattedText())
                        </div>
                        
                        @if (!state.IsTextFullyDisplayed && currentDialogue?.AnimationType == TextAnimationType.Typewriter)
                        {
                            <div class="typing-cursor @GetCursorClass()">|</div>
                        }
                    </div>
                </div>

                <!-- Control Buttons at Bottom Right -->
                <div class="dialogue-controls-bottom">
                    @if (config.ShowSkipButton && !state.IsTextFullyDisplayed)
                    {
                        <button class="control-btn skip-btn @GetControlButtonClass()" @onclick="SkipText" title="Skip to end of text">
                            <span class="btn-icon">⏭️</span>
                            <span class="btn-text">Skip</span>
                            <div class="btn-effect"></div>
                        </button>
                    }

                    @if (config.ShowContinueButton && state.IsTextFullyDisplayed && !IsLastDialogue())
                    {
                        <button class="control-btn continue-btn @GetControlButtonClass()" @onclick="ContinueToNext" title="Continue to next dialogue">
                            <span class="btn-icon">▶️</span>
                            <span class="btn-text">Continue</span>
                            <div class="btn-effect"></div>
                        </button>
                    }
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="loading-screen @GetThemeClass()">
            <div class="loading-content">
                <div class="loading-spinner @GetSpinnerClass()"></div>
                <h2>Loading Visual Novel...</h2>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public string? Theme { get; set; }
    [Parameter] public VisualNovelScene? Scene { get; set; }
    [Parameter] public VisualNovelConfig? Configuration { get; set; }
    [Parameter] public EventCallback<VisualNovelState> OnStateChanged { get; set; }
    [Parameter] public EventCallback OnSceneComplete { get; set; }

    private VisualNovelConfig config = new();
    private VisualNovelState state = new();
    private VisualNovelScene? currentScene;
    private DialogueLine? currentDialogue;
    private ElementReference dialogueTextElement;
    
    private Timer? typewriterTimer;
    private int currentTextIndex = 0;
    private string displayedText = "";
    private bool isDisposed = false;

    protected override async Task OnInitializedAsync()
    {
        // Initialize configuration
        if (Configuration != null)
            config = Configuration;
        
        // Set theme from parameter
        if (!string.IsNullOrEmpty(Theme))
        {
            if (Enum.TryParse<NovelTheme>(Theme, true, out var themeEnum))
                config.Theme = themeEnum;
        }

        // Initialize scene
        if (Scene != null)
        {
            currentScene = Scene;
            state.CurrentSceneId = Scene.Id;
            await StartDialogue();
        }
        else
        {
            // Load demo scene if no scene provided
            currentScene = CreateDemoScene();
            await StartDialogue();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && currentDialogue != null)
        {
            await StartTextAnimation();
        }
    }

    private async Task StartDialogue()
    {
        if (currentScene == null || !currentScene.DialogueLines.Any()) return;
        
        currentDialogue = currentScene.DialogueLines[state.CurrentDialogueIndex];
        UpdateCharacterStates();
        await InvokeStateChanged();
    }

    private async Task StartTextAnimation()
    {
        if (currentDialogue == null) return;

        displayedText = "";
        currentTextIndex = 0;
        state.IsTextFullyDisplayed = false;

        switch (currentDialogue.AnimationType)
        {
            case TextAnimationType.Typewriter:
                await StartTypewriterEffect();
                break;
            case TextAnimationType.Instant:
                displayedText = currentDialogue.Text;
                state.IsTextFullyDisplayed = true;
                StateHasChanged();
                break;
            case TextAnimationType.FadeIn:
            case TextAnimationType.SlideUp:
                displayedText = currentDialogue.Text;
                state.IsTextFullyDisplayed = true;
                StateHasChanged();
                break;
        }

        await InvokeStateChanged();
    }

    private async Task StartTypewriterEffect()
    {
        if (currentDialogue == null || isDisposed) return;

        var speed = currentDialogue.TypewriterSpeed > 0 ? currentDialogue.TypewriterSpeed : config.DefaultTypewriterSpeed;
        
        typewriterTimer?.Dispose();
        typewriterTimer = new Timer(async _ =>
        {
            if (isDisposed || currentDialogue == null) return;

            await InvokeAsync(() =>
            {
                if (currentTextIndex < currentDialogue.Text.Length)
                {
                    displayedText += currentDialogue.Text[currentTextIndex];
                    currentTextIndex++;
                    StateHasChanged();
                }
                else
                {
                    state.IsTextFullyDisplayed = true;
                    typewriterTimer?.Dispose();
                    StateHasChanged();
                    
                    // Auto-continue if enabled
                    if (currentDialogue.AutoContinue && !IsLastDialogue())
                    {
                        _ = Task.Delay(currentDialogue.AutoContinueDelay).ContinueWith(async _ =>
                        {
                            if (!isDisposed)
                                await InvokeAsync(ContinueToNext);
                        });
                    }
                }
            });
        }, null, 0, speed);
    }

    private async Task SkipText()
    {
        if (currentDialogue == null) return;

        typewriterTimer?.Dispose();
        displayedText = currentDialogue.Text;
        state.IsTextFullyDisplayed = true;
        StateHasChanged();
        await InvokeStateChanged();
    }

    private async Task ContinueToNext()
    {
        if (IsLastDialogue())
        {
            await OnSceneComplete.InvokeAsync();
            return;
        }

        state.CurrentDialogueIndex++;
        currentDialogue = currentScene?.DialogueLines[state.CurrentDialogueIndex];
        UpdateCharacterStates();
        await StartTextAnimation();
    }


    private void UpdateCharacterStates()
    {
        if (currentScene == null || currentDialogue == null) return;

        // Reset all characters to inactive
        foreach (var character in currentScene.Characters)
            character.IsActive = false;

        // Set current speaker as active
        var speaker = currentScene.Characters.FirstOrDefault(c => c.Id == currentDialogue.CharacterId);
        if (speaker != null)
            speaker.IsActive = true;
    }

    private VisualNovelCharacter? GetCurrentSpeaker()
    {
        if (currentScene == null || currentDialogue == null) return null;
        return currentScene.Characters.FirstOrDefault(c => c.Id == currentDialogue.CharacterId);
    }

    private bool IsLastDialogue()
    {
        return currentScene == null || state.CurrentDialogueIndex >= currentScene.DialogueLines.Count - 1;
    }

    private async Task InvokeStateChanged()
    {
        await OnStateChanged.InvokeAsync(state);
    }

    private string GetFormattedText()
    {
        return displayedText.Replace("\n", "<br/>");
    }

    // CSS Class Methods
    private string GetThemeClass() => config.Theme.ToString().ToLower();
    private string GetBackgroundClass() => $"background-{config.Theme.ToString().ToLower()}";
    private string GetLayoutClass() => currentScene?.Layout.ToString().ToLower() ?? "single";
    private string GetDialogueBoxClass() => $"dialogue-{config.Theme.ToString().ToLower()}";
    private string GetNameTagClass() => $"name-tag-{config.Theme.ToString().ToLower()}";
    private string GetTextAnimationClass() => currentDialogue?.AnimationType.ToString().ToLower() ?? "typewriter";
    private string GetCursorClass() => $"cursor-{config.Theme.ToString().ToLower()}";
    private string GetControlButtonClass() => $"control-{config.Theme.ToString().ToLower()}";
    private string GetSpinnerClass() => $"spinner-{config.Theme.ToString().ToLower()}";
    
    private string GetCharacterPositionClass(VisualNovelCharacter character)
    {
        return character.Position.ToString().ToLower() + "-character";
    }

    private VisualNovelScene CreateDemoScene()
    {
        var scene = new VisualNovelScene
        {
            Name = "Demo Scene",
            Layout = SceneLayout.DualCharacters,
            Theme = config.Theme
        };

        // Add demo characters based on theme
        if (config.Theme == NovelTheme.Piltover)
        {
            scene.Characters.AddRange(new[]
            {
                new VisualNovelCharacter
                {
                    Id = "jayce",
                    Name = "Jayce",
                    DisplayName = "Jayce Talis",
                    ImagePath = "/images/Jayce.jpeg",
                    Position = CharacterPosition.Left,
                    ThemeColor = "#c8aa6e"
                },
                new VisualNovelCharacter
                {
                    Id = "viktor",
                    Name = "Viktor",
                    DisplayName = "Viktor",
                    ImagePath = "/images/Viktor.jpeg",
                    Position = CharacterPosition.Right,
                    ThemeColor = "#0596aa"
                }
            });

            scene.DialogueLines.AddRange(new[]
            {
                new DialogueLine
                {
                    CharacterId = "jayce",
                    Text = "The Hextech research shows promising results, Viktor. We're on the verge of a breakthrough that could change everything.",
                    AnimationType = TextAnimationType.Typewriter,
                    TypewriterSpeed = 40
                },
                new DialogueLine
                {
                    CharacterId = "viktor",
                    Text = "Indeed, Jayce. But we must consider the implications. Progress without wisdom is merely chaos in disguise.",
                    AnimationType = TextAnimationType.Typewriter,
                    TypewriterSpeed = 45
                },
                new DialogueLine
                {
                    CharacterId = "jayce",
                    Text = "You're right to be cautious. But think of what we could accomplish - clean energy for all of Piltover, maybe even beyond.",
                    AnimationType = TextAnimationType.Typewriter,
                    TypewriterSpeed = 40
                }
            });
        }
        else
        {
            scene.Characters.AddRange(new[]
            {
                new VisualNovelCharacter
                {
                    Id = "vi",
                    Name = "Vi",
                    DisplayName = "Vi",
                    ImagePath = "/images/Vi.jpeg",
                    Position = CharacterPosition.Left,
                    ThemeColor = "#00d4aa"
                },
                new VisualNovelCharacter
                {
                    Id = "caitlyn",
                    Name = "Caitlyn",
                    DisplayName = "Sheriff Caitlyn",
                    ImagePath = "/images/Cait.jpeg",
                    Position = CharacterPosition.Right,
                    ThemeColor = "#ff007f"
                }
            });

            scene.DialogueLines.AddRange(new[]
            {
                new DialogueLine
                {
                    CharacterId = "vi",
                    Text = "Cupcake, you seeing this? The chemical levels down here are off the charts. Something big is going down.",
                    AnimationType = TextAnimationType.Typewriter,
                    TypewriterSpeed = 35
                },
                new DialogueLine
                {
                    CharacterId = "caitlyn",
                    Text = "I see it, Vi. The readings match what we found at the warehouse. Someone's been manufacturing Shimmer on an industrial scale.",
                    AnimationType = TextAnimationType.Typewriter,
                    TypewriterSpeed = 50
                },
                new DialogueLine
                {
                    CharacterId = "vi",
                    Text = "Then we better move fast. In Zaun, when the Chem-Barons get desperate, innocent people pay the price.",
                    AnimationType = TextAnimationType.Typewriter,
                    TypewriterSpeed = 35
                }
            });
        }

        return scene;
    }

    public void Dispose()
    {
        isDisposed = true;
        typewriterTimer?.Dispose();
    }
}

<style>
/********************************************
 * Visual Novel Container & Base Styling
 ********************************************/
.visual-novel {
    position: relative;
    width: 100%;
    height: 100vh;
    overflow: hidden;
    font-family: 'Rajdhani', sans-serif;
    color: #fff;
    display: flex;
    flex-direction: column;
}

/********************************************
 * Theme-Specific Backgrounds
 ********************************************/
.visual-novel.piltover {
    background: linear-gradient(135deg, #2c1810 0%, #5a4a3a 30%, #c8aa6e 100%);
}

.visual-novel.zaun {
    background: linear-gradient(135deg, #0a1e16 0%, #1a3a2e 30%, #00d4aa 100%);
}

/********************************************
 * Scene Background
 ********************************************/
.scene-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
}

.background-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    filter: brightness(0.8);
}

.background-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.4);
    z-index: 2;
}

.atmospheric-effects {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 3;
    pointer-events: none;
}

.background-piltover .atmospheric-effects {
    background: radial-gradient(circle at 20% 50%, rgba(200, 170, 110, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 215, 0, 0.05) 0%, transparent 50%);
}

.background-zaun .atmospheric-effects {
    background: radial-gradient(circle at 30% 70%, rgba(0, 212, 170, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 70% 30%, rgba(0, 255, 200, 0.05) 0%, transparent 50%);
}

/********************************************
 * Character Layer
 ********************************************/
.characters-layer {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 4;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    padding-bottom: 35%;
}

.characters-layer.single {
    justify-content: center;
}

.characters-layer.dualcharacters {
    justify-content: space-between;
    padding: 0 10%;
}

.character-container {
    position: relative;
    transition: all 0.5s ease;
    filter: brightness(0.6) saturate(0.5);
    transform: scale(0.95);
}

.character-container.active {
    filter: brightness(1) saturate(1);
    transform: scale(1);
    z-index: 5;
}

.character-container.inactive {
    filter: brightness(0.4) saturate(0.3);
    transform: scale(0.9);
}

.character-portrait {
    position: relative;
    display: flex;
    align-items: flex-end;
}

.portrait-image {
    max-height: 70vh;
    max-width: 400px;
    object-fit: contain;
    filter: drop-shadow(0 10px 30px rgba(0, 0, 0, 0.5));
}

.character-glow {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.5s ease;
}

.character-container.active .character-glow {
    opacity: 1;
}

.visual-novel.piltover .character-container.active .character-glow {
    box-shadow: 0 0 50px rgba(200, 170, 110, 0.3);
    background: radial-gradient(circle at center, rgba(200, 170, 110, 0.1) 0%, transparent 70%);
}

.visual-novel.zaun .character-container.active .character-glow {
    box-shadow: 0 0 50px rgba(0, 212, 170, 0.3);
    background: radial-gradient(circle at center, rgba(0, 212, 170, 0.1) 0%, transparent 70%);
}

.left-character {
    align-self: flex-end;
}

.right-character {
    align-self: flex-end;
}

.center-character {
    align-self: flex-end;
}

/********************************************
 * Dialogue Section
 ********************************************/
.dialogue-section {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 6;
    padding: 2rem;
}

.dialogue-box {
    position: relative;
    min-height: 120px;
    background: rgba(0, 0, 0, 0.8);
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.dialogue-piltover {
    /* No special styling */
}

.dialogue-zaun {
    /* No special styling */
}

/********************************************
 * Dialogue Controls
 ********************************************/
.dialogue-controls-bottom {
    position: absolute;
    bottom: 15px;
    right: 20px;
    display: flex;
    gap: 10px;
    z-index: 7;
}

.control-btn {
    padding: 6px 12px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 4px;
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    font-size: 0.9rem;
    cursor: pointer;
}

.control-btn:hover {
    background: rgba(255, 255, 255, 0.2);
}

.control-piltover {
    /* No special styling */
}

.control-zaun {
    /* No special styling */
}

.btn-effect {
    /* Removed */
}

.btn-icon {
    /* No special styling */
}

.btn-text {
    /* No special styling */
}

/********************************************
 * Character Name Tag
 ********************************************/
.character-name-tag {
    display: inline-block;
    margin-bottom: 0.5rem;
    padding: 4px 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    font-weight: 600;
    font-size: 1rem;
    color: #fff;
}

.name-tag-piltover {
    /* No special styling */
}

.name-tag-zaun {
    /* No special styling */
}

.character-name {
    /* No special styling */
}

.name-tag-decoration {
    /* Removed */
}

/********************************************
 * Dialogue Content
 ********************************************/
.dialogue-content {
    /* No special styling */
}

.dialogue-text-container {
    /* No special styling */
}

.dialogue-text {
    font-size: 1.2rem;
    line-height: 1.5;
    color: #fff;
}

/* Text Animation Classes */
.dialogue-text.typewriter {
    /* Typewriter effect handled by C# code */
}

.dialogue-text.fadein {
    animation: fadeInText 1s ease-in;
}

.dialogue-text.slideup {
    animation: slideUpText 0.8s ease-out;
}

.dialogue-text.instant {
    /* No animation */
}

@@keyframes fadeInText {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@@keyframes slideUpText {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/********************************************
 * Typing Cursor
 ********************************************/
.typing-cursor {
    font-size: 1.2rem;
    margin-left: 4px;
    animation: blink 1s infinite;
    color: #fff;
}

.cursor-piltover {
    /* No special styling */
}

.cursor-zaun {
    /* No special styling */
}

@@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
}

/********************************************
 * Loading Screen
 ********************************************/
.loading-screen {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100vh;
}

.loading-content {
    text-align: center;
    color: #fff;
}

.loading-content h2 {
    font-family: 'Arcane Nine', 'Cinzel', serif;
    font-size: 2rem;
    margin-top: 2rem;
    opacity: 0.8;
}

.loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    border-top-color: #c8aa6e;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

.spinner-piltover {
    border-top-color: #c8aa6e;
}

.spinner-zaun {
    border-top-color: #00d4aa;
}

@@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

/********************************************
 * Responsive Design
 ********************************************/
@@media (max-width: 768px) {
    .dialogue-section {
        padding: 1rem;
    }
    
    .dialogue-box {
        padding: 0.75rem;
        min-height: 100px;
    }
    
    .dialogue-text {
        font-size: 1.1rem;
    }
    
    .character-name-tag {
        font-size: 0.9rem;
        padding: 3px 6px;
    }
    
    .characters-layer.dualcharacters {
        padding: 0 5%;
    }
    
    .portrait-image {
        max-height: 60vh;
        max-width: 300px;
    }
    
    .control-btn {
        padding: 4px 8px;
        font-size: 0.8rem;
    }
    
    .dialogue-controls-bottom {
        bottom: 10px;
        right: 15px;
    }
}

@@media (max-width: 480px) {
    .dialogue-text {
        font-size: 1rem;
    }
    
    .portrait-image {
        max-height: 50vh;
        max-width: 250px;
    }
    
    .dialogue-box {
        min-height: 80px;
        padding: 0.5rem;
    }
    
    .character-name-tag {
        font-size: 0.8rem;
    }
    
    .dialogue-controls-bottom {
        bottom: 8px;
        right: 10px;
    }
}

/********************************************
 * Hardware Acceleration & Performance
 ********************************************/
.character-container,
.dialogue-box,
.control-btn {
    will-change: transform;
    transform: translateZ(0);
}

.portrait-image {
    backface-visibility: hidden;
    perspective: 1000px;
}

/* Smooth scrolling for long dialogue */
.dialogue-text {
    scroll-behavior: smooth;
}
</style>