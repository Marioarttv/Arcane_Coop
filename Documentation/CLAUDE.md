# Arcane Coop - Claude.md

This file provides guidance to Claude Code when working with the Arcane Coop escape room project.

## Project Overview

**Arcane Coop** is a sophisticated cooperative puzzle game platform built with ASP.NET Core Blazor Server (.NET 9.0). Set in the Arcane universe, it features 7 distinct puzzle systems where two players representing Zaun and Piltover must work together to solve challenges through real-time communication and collaboration.

## Development Commands

### Build Commands
```bash
dotnet build
dotnet clean
dotnet restore
```

### Running the Application
**Note: The user prefers to run the application manually.**
The application runs on:
- HTTP: http://localhost:5055
- HTTPS: https://localhost:7104

When the user runs `dotnet run`, the application will be available at the above URLs.

### Publishing
```bash
dotnet publish -c Release
```

## Architecture

### Project Structure
- **Program.cs**: Main entry point with minimal API setup
- **Components/**: Contains all Razor components
  - **App.razor**: Root component with HTML document structure
  - **Routes.razor**: Router configuration
  - **_Imports.razor**: Global using statements
  - **Layout/MainLayout.razor**: Base layout component
  - **Pages/**: Page components
    - **LandingPage.razor**: Main game selection page with extensive CSS styling
    - **Error.razor**: Standard error page

### Technology Stack
- **Framework**: ASP.NET Core 9.0 with Blazor Server
- **Rendering**: Interactive Server Components
- **Styling**: Component-scoped CSS with extensive custom styling
- **Fonts**: Custom "Arcane Nine" font and Google Fonts (Orbitron, Cinzel, Rajdhani)

### Core Features
- **7 Cooperative Puzzle Systems** - Each with unique mechanics and educational focus
- **Real-time Multiplayer** - SignalR-powered synchronization between players
- **Dual-theme Arcane Design** - Zaun (teal/underground) vs Piltover (gold/clean) aesthetics
- **Role-based Gameplay** - Players have different views and responsibilities
- **Educational Focus** - Designed for ESL students and skill development

### Development Patterns
- Uses **minimal APIs** for simple setup
- **Component-scoped CSS** with extensive styling (1000+ lines in LandingPage)
- **Enum-based** city selection (City.Zaun, City.Piltover)
- **Async/await** patterns for component interactions
- **Cascading parameters** for context sharing
- **CSS @ symbols must be escaped** in Razor components: use `@@keyframes`, `@@media`, `@@import`, `@@font-face`

### Visual Novel Multiplayer Editor Notes (2025)

For reliable Visual Novel behavior in multiplayer (Act 1) and in the visual editor:

- Use `CancellationTokenSource` and a `CancelTypewriter()` helper to cancel any in-flight typewriter animation
- Reset local text state (`displayedText`, `currentTextIndex`) and force a render before starting a new animation to avoid first-character carry-over
- On Skip, cancel the animation and set the full line once; also notify the server (see `Act1TypingCompleted`) so both clients' buttons flip from Skip → Continue
- Add a `Act1TypingCompleted(roomId)` hub method that marks `IsTextAnimating=false` and `GameState.IsTextFullyDisplayed=true`, then broadcasts the updated `Act1PlayerView`
- After `Act1SceneTransition`, add a short client fallback (e.g., 4s) to navigate to the next game if the redirect message is missed

### Static Assets
- Located in **wwwroot/**
- Character images: Vi.jpeg, Cait.jpeg, Jayce.jpeg, Viktor.jpeg
- Custom font: Arcane Nine.otf
- Component-specific CSS files generated by build process

### Configuration
- Standard ASP.NET Core configuration in **appsettings.json**
- Development/Production environment support
- HTTPS redirection and HSTS enabled for production

## Legacy Systems

### Tic-Tac-Toe Demo (/test-signalr)
Early proof-of-concept for SignalR multiplayer functionality. Fully functional with real-time synchronization, but not part of the main escape room experience.



## SignalR Best Practices Summary

Key guidelines for robust multiplayer implementation:

- **Type Safety**: Always use strongly-typed data models for SignalR messages
- **State Sync**: Update both game state and player views after changes
- **Connection Management**: Handle joins, leaves, and disconnections gracefully
- **Server Validation**: Never trust client input - validate all actions server-side
- **Error Handling**: Comprehensive error messages and proper exception handling
- **Performance**: Use concurrent collections and batch updates when possible

See individual puzzle documentation for implementation examples.


## Puzzle Systems Overview

The project features 7 distinct cooperative puzzle systems, each designed for 2 players with asymmetric information and roles:

### 1. CodeCracker (/code-cracker)
**Purpose**: Vocabulary building and communication
**Players**: Piltover (sees distorted words) + Zaunite (gets clues)
**Mechanics**: Word decryption with hints and scoring
**Education**: ESL vocabulary, German translations
**Documentation**: [CodeCracker.md](./CodeCracker.md)

### 2. SignalDecoder (/signal-decoder) 
**Purpose**: Listening comprehension
**Players**: Piltover (sees incomplete text) + Zaunite (hears audio)
**Mechanics**: Audio-text coordination with emergency scenarios
**Education**: Listening skills, emergency vocabulary
**Documentation**: [SignalDecoder.md](./SignalDecoder.md)

### 3. NavigationMaze (/navigation-maze)
**Purpose**: Spatial reasoning and direction following
**Players**: Piltover (map navigator) + Zaunite (first-person explorer)
**Mechanics**: Pathfinding through dangerous Zaun locations
**Education**: Prepositions, spatial vocabulary
**Documentation**: [NavigationMaze.md](./NavigationMaze.md)

### 4. PictureExplanation (/picture-explanation)
**Purpose**: Visual communication over voice chat
**Players**: Piltover (image describer) + Zaunite (choice selector)
**Mechanics**: Describe → Hide → Choose from 4 options
**Education**: Descriptive language, active listening
**Documentation**: [PictureExplanation.md](./PictureExplanation.md)
**Story Transition and Role Preservation**

- From Act 1, send each client an individualized redirect (not a single group URL) including: `role`, `avatar`, `name`, `squad`, `story=true`
- In `PictureExplanation.razor`, when `story=true`, immediately set `inGame = true` after join to bypass the lobby for both Piltover and Zaun
- Add `JoinPictureExplanationGameWithRole(roomId, playerName, requestedRole)` to honor requested roles while preventing duplicates (second player is assigned the remaining role)

### 5. RuneProtocol (/rune-protocol)
**Purpose**: Logic puzzles and conditional reasoning
**Players**: Piltover (R1-R4) + Zaunite (R5-R8)
**Mechanics**: Satisfy complex rule conditions through coordination
**Education**: Logic, Boolean algebra, systems thinking
**Documentation**: [RuneProtocol.md](./RuneProtocol.md)

### 6. AlchemyLab (/alchemy-lab)
**Purpose**: Process following and drag-and-drop interaction
**Players**: Piltover (recipe reader) + Zaunite (hands-on brewer)
**Mechanics**: Multi-step ingredient processing and combination
**Education**: Following instructions, sequential thinking
**Documentation**: [AlchemyLab.md](./AlchemyLab.md)

### 7. VisualNovel (/visual-novel)
**Purpose**: Narrative delivery and story immersion
**Players**: Single or dual player story experience
**Mechanics**: Text animation, character expressions, thematic presentation
**Education**: Reading comprehension, cultural context
**Documentation**: [VisualNovel.md](./VisualNovel.md)

## Technical Architecture

### Multiplayer Infrastructure
- **SignalR Hubs**: Real-time communication via GameHub.cs
- **Room-based Games**: Players join rooms using shared codes
- **Role Assignment**: First player = Piltover, Second = Zaunite
  - Story override: per-player URL `role` can request Piltover/Zaun; server resolves conflicts and ensures distinct roles
- **State Synchronization**: Server-side validation with client updates
- **Connection Management**: Graceful handling of disconnections

### Data Models
- **Game-specific Models**: Each puzzle has dedicated model classes
- **Player Views**: Role-specific data structures for asymmetric gameplay
- **Game States**: Comprehensive state tracking for all game phases

### Component Architecture
- **Page Components**: Each puzzle is a standalone Blazor page
- **Shared Services**: Common functionality via dependency injection
- **CSS Theming**: Consistent Piltover/Zaun visual identity
- **Responsive Design**: Desktop-first with mobile support

## Development Guidelines

### Adding New Puzzles
1. Create page component in Components/Pages/
2. Add models in Models/ directory
3. Implement SignalR methods in GameHub.cs
4. Create comprehensive documentation in Documentation/
5. Update this CLAUDE.md with basic overview

### Code Standards
- **SignalR Type Safety**: Always use strongly-typed data models
- **Error Handling**: Graceful degradation for network issues
- **State Management**: Separate client/server state concerns
- **Animation**: Hardware-accelerated CSS for 60fps performance
- **Accessibility**: ARIA labels and keyboard navigation

### Educational Focus
- **German ESL Students**: Primary target audience
- **Collaborative Learning**: Peer-to-peer skill development
- **Progressive Difficulty**: Scaffolded complexity increases
- **Multiple Modalities**: Visual, auditory, kinesthetic learning styles

## File Organization

### Core Files
- **Program.cs**: Application entry point and service configuration
- **GameHub.cs**: SignalR hub with all multiplayer functionality
- **appsettings.json**: Configuration for development and production

### Component Structure
- **Pages/**: All puzzle components and main game pages
- **Models/**: Data models for each puzzle system
- **Services/**: Shared services (VisualNovelService, etc.)
- **wwwroot/**: Static assets (images, audio, fonts, styles)

### Documentation Structure
- **CLAUDE.md**: This overview and development guidance
- **[PuzzleName].md**: Detailed documentation for each puzzle system
- **Specialized docs**: Technical deep-dives for complex systems

## GameHub.cs - Central SignalR Hub Documentation

The `GameHub.cs` file (3,357 lines) serves as the central multiplayer coordination hub for all puzzle systems in the Arcane Coop project. This SignalR hub manages real-time communication, game state synchronization, and player coordination across all puzzle types.

### File Structure Overview

**Core Infrastructure (Lines 1-64)**
- Static game dictionaries for each puzzle type
- Room and player management
- Basic SignalR connection handling

**Game-Specific Sections:**
- **Tic-Tac-Toe** (Lines 65-111): Legacy demo system with basic turn-based gameplay
- **CodeCracker** (Lines 112-190): Vocabulary puzzle with word guessing and hint system
- **SignalDecoder** (Lines 191-286): Audio-based emergency transmission decoding
- **NavigationMaze** (Lines 287-381): Spatial navigation with route planning
- **AlchemyLab** (Lines 382-524): Drag-and-drop ingredient processing and brewing
- **RuneProtocol** (Lines 525-670): Complex logic puzzle with conditional rule systems
- **PictureExplanation** (Lines 671-825): Voice chat visual communication challenges
- **Word-Forge** (Lines 826-934): Advanced word formation and affix combinations

**Connection Management (Lines 935-end)**: Player disconnection handling and cleanup

### Static Game Storage Architecture

```csharp
// Each puzzle type maintains its own concurrent dictionary (Lines 10-18)
private static readonly ConcurrentDictionary<string, TicTacToeGame> _games = new();
private static readonly ConcurrentDictionary<string, CodeCrackerGame> _codeCrackerGames = new();
private static readonly ConcurrentDictionary<string, SimpleSignalDecoderGame> _signalDecoderGames = new();
private static readonly ConcurrentDictionary<string, NavigationMazeGame> _navigationMazeGames = new();
private static readonly ConcurrentDictionary<string, AlchemyGame> _alchemyGames = new();
private static readonly ConcurrentDictionary<string, RuneProtocolGame> _runeProtocolGames = new();
private static readonly ConcurrentDictionary<string, PictureExplanationGame> _pictureExplanationGames = new();
private static readonly ConcurrentDictionary<string, WordForgeGame> _wordForgeGames = new();
private static readonly ConcurrentDictionary<string, ConcurrentDictionary<string, string>> _roomPlayers = new();
```

### Common Method Patterns

Each puzzle section follows consistent patterns:

#### 1. **Join Game Methods** (Lines 113, 192, 288, 383, 526, 672, 827)
- Pattern: `JoinXXXGame(string roomId, string playerName)`
- Adds player to SignalR group
- Creates or retrieves game instance
- Assigns player role (typically Piltover vs Zaunite)
- Sends initial game state and player-specific view

#### 2. **Game Action Methods** (Varies by puzzle)
- **CodeCracker**: `SubmitCodeCrackerGuess()` (Line 132), `RequestCodeCrackerHint()` (Line 163)
- **SignalDecoder**: `SubmitSignalDecoding()` (Line 232)
- **NavigationMaze**: `MakeNavigationChoice()` (Line 315)
- **AlchemyLab**: `ProcessIngredient()` (Line 409), `AddToCauldron()` (Line 440), `SubmitPotion()` (Line 473)
- **RuneProtocol**: `ToggleRune()` (Line 557), `ToggleRuneProtocolValidationHints()` (Line 602)
- **PictureExplanation**: `SubmitPictureChoice()` (Line 736), `NextPictureRound()` (Line 780)
- **Word-Forge**: `ForgeWordCombination()` (Line 890)

#### 3. **Restart/Reset Methods** (Lines 176, 243, 353, 510, 637, 810, 919)
- Pattern: `RestartXXXGame(string roomId)`
- Resets game state to initial conditions
- Broadcasts updated state to all players

### Advanced Features by Puzzle

#### **CodeCracker (Lines 112-190)**
- **Hint System**: Players can request hints with usage tracking
- **Scoring System**: Points based on speed and accuracy
- **Progressive Difficulty**: Word complexity increases through rounds
- **Animation Coordination**: 2.5-second delays for success animations

#### **SignalDecoder (Lines 191-286)**
- **Emergency Scenarios**: Multiple crisis types (medical, fire, police, disasters)
- **Signal Degradation**: Time-based signal quality reduction
- **Audio Integration**: Coordinated audio playback for realistic communication

#### **NavigationMaze (Lines 287-381)**
- **Role Separation**: Navigator (map view) vs Explorer (first-person view)
- **Location Progression**: 5-stage journey with increasing complexity
- **Failure Handling**: Thematic game-over messages with restart capability

#### **AlchemyLab (Lines 382-524)**
- **Multi-Step Processing**: Ingredient transformation through multiple stations
- **Drag-and-Drop Validation**: Server-side verification of ingredient movements
- **Recipe Validation**: Complex 4-step brewing process with combination mechanics
- **State Synchronization**: Real-time ingredient pool updates

#### **RuneProtocol (Lines 525-670)**
- **Logic Engine**: Advanced rule validation with conditional statements
- **Hint Toggling**: Optional validation feedback system
- **Level Progression**: Multiple difficulty levels with unique rule sets
- **Victory Detection**: Rule-satisfaction analysis rather than hardcoded solutions

#### **PictureExplanation (Lines 671-825)**
- **Voice Chat Integration**: Designed for external voice communication
- **Image Management**: Hide/show mechanics for strategic gameplay
- **Round Progression**: 5-round structure with increasing difficulty
- **Choice Validation**: Server-side image selection verification

#### **Word-Forge (Lines 826-934)**
- **Affix System**: Complex word formation with prefixes and suffixes
- **Game Modes**: Assisted vs Challenge difficulty levels
- **Combination Tracking**: Progress monitoring for word formation goals

### SignalR Event Patterns

Each puzzle broadcasts standardized event types:
- **`XXXGameJoined`**: Player successfully joins with role assignment
- **`XXXGameStateUpdated`**: Global game state changes
- **`XXXPlayerViewUpdated`**: Individual player-specific information updates
- **`XXXGameCompleted`**: Victory conditions met
- **`XXXGameFull`**: Room capacity reached
- **Invalid Action Events**: Puzzle-specific error handling

### Performance and Scalability Features

#### **Thread Safety**
- `ConcurrentDictionary` usage throughout for thread-safe operations
- Atomic game state updates to prevent race conditions

#### **Memory Management**
- Automatic cleanup of empty rooms in `OnDisconnectedAsync()` (Line 935)
- Player tracking removal on disconnection
- Game instance cleanup when no players remain

#### **Error Handling**
- Comprehensive try-catch blocks for game operations
- Graceful degradation when games not found
- Client-side validation with server-side verification

### Future Maintenance Guidelines

#### **Adding New Puzzles**
1. **Add Static Dictionary** (after Line 18): `private static readonly ConcurrentDictionary<string, NewPuzzleGame> _newPuzzleGames = new();`
2. **Insert Methods Section** (after Line 934): Follow established patterns for Join/Action/Restart methods
3. **Update Documentation**: Add line ranges and method descriptions to this section

#### **Modifying Existing Puzzles**
- **CodeCracker**: Lines 112-190 - Word bank and scoring modifications
- **SignalDecoder**: Lines 191-286 - Emergency scenario additions
- **NavigationMaze**: Lines 287-381 - Location progression changes
- **AlchemyLab**: Lines 382-524 - Recipe and ingredient system updates
- **RuneProtocol**: Lines 525-670 - Logic rule additions and level creation
- **PictureExplanation**: Lines 671-825 - Image set and round structure changes
- **Word-Forge**: Lines 826-934 - Affix system and difficulty adjustments

#### **Connection Management**
- Room cleanup logic: Lines 935-960
- Player tracking: Lines 20-53
- Group management: Standard SignalR patterns throughout

This centralized architecture allows for consistent multiplayer experiences across all puzzle types while maintaining clear separation of concerns for each game system.